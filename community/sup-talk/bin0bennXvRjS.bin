From 094962e04eafc50ba707c0c35885f161c0fc9641 Mon Sep 17 00:00:00 2001
From: Helge Titlestad <helgedt@tihlde.org>
Date: Tue, 3 Nov 2009 20:11:25 +0100
Subject: [PATCH] Detect charset for text/* file attachments.

Adds dependency on rchardet gem, and uses it to detect the charset.
---
 README.txt      |    1 +
 Rakefile        |    1 +
 lib/sup/util.rb |    9 ++++++++-
 3 files changed, 10 insertions(+), 1 deletions(-)

diff --git a/README.txt b/README.txt
index 4204270..184dd09 100644
--- a/README.txt
+++ b/README.txt
@@ -106,6 +106,7 @@ Current limitations which will be fixed:
  - mime-types
  - gettext
  - fastthread
+ - rchardet
 
 == INSTALL:
 
diff --git a/Rakefile b/Rakefile
index 67cd0d2..c8d9243 100644
--- a/Rakefile
+++ b/Rakefile
@@ -57,6 +57,7 @@ spec = Gem::Specification.new do |s|
   s.add_dependency "mime-types", "~> 1"
   s.add_dependency "gettext"
   s.add_dependency "fastthread"
+  s.add_dependency "rchardet", ">= 1.3"
 end
 
 Rake::GemPackageTask.new(spec) do |pkg|
diff --git a/lib/sup/util.rb b/lib/sup/util.rb
index f99e1c1..7b747fb 100644
--- a/lib/sup/util.rb
+++ b/lib/sup/util.rb
@@ -3,6 +3,7 @@ require 'lockfile'
 require 'mime/types'
 require 'pathname'
 require 'set'
+require 'rchardet'
 
 ## time for some monkeypatching!
 class Lockfile
@@ -71,8 +72,14 @@ module RMail
 
     def self.make_attachment payload, mime_type, encoding, filename
       a = Message.new
+
+      cs = CharDet.detect(payload)['encoding'] if mime_type =~ /^text\//i
+debug(cs)
+      ct = "#{mime_type}; name=#{filename.inspect}"
+      ct += "; charset=#{cs}" if cs
+      
       a.header.add "Content-Disposition", "attachment; filename=#{filename.inspect}"
-      a.header.add "Content-Type", "#{mime_type}; name=#{filename.inspect}"
+      a.header.add "Content-Type", ct
       a.header.add "Content-Transfer-Encoding", encoding if encoding
       a.body =
         case encoding
-- 
1.5.6.5

