From 71047a972968dd6fae0b760b400ea05438993fef Mon Sep 17 00:00:00 2001
From: Rick Tessner <rick@onnadayr.ca>
Date: Thu, 15 Oct 2009 12:55:27 -0700
Subject: [PATCH] Corrects "Use terminal width instead of hardcoded 80 as the wrap length."

This corrects commit f0c7e30dec3e18b0ff59dff28c741422e5f7d10e.
---
 lib/sup/message-chunks.rb |    7 +++++--
 1 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/lib/sup/message-chunks.rb b/lib/sup/message-chunks.rb
index a74b442..f19c8fe 100644
--- a/lib/sup/message-chunks.rb
+++ b/lib/sup/message-chunks.rb
@@ -41,6 +41,7 @@ end
 
 module Redwood
 module Chunk
+  WRAP_LEN = 80 # wrap messages and text attachments at this width
 
   class Attachment
     HookManager.register "mime-decode", <<EOS
@@ -108,8 +109,9 @@ EOS
 
       @lines = nil
       if text
+        wrap_len = Ncurses.cols rescue WRAP_LEN  # Ncurses fails in sup-sync & friends ...
         @lines = text.gsub("\r\n", "\n").gsub(/\t/, "        ").gsub(/\r/, "").split("\n")
-        @lines = lines.map {|l| l.chomp.wrap Ncurses.cols}.flatten
+        @lines = lines.map {|l| l.chomp.wrap wrap_len}.flatten
         @quotable = true
       end
     end
@@ -161,7 +163,8 @@ EOS
 
     attr_reader :lines
     def initialize lines
-      @lines = lines.map { |l| l.chomp.wrap Ncurses.cols }.flatten # wrap
+      wrap_len = Ncurses.cols rescue WRAP_LEN  # Ncurses fails in sup-sync & friends ...
+      @lines = lines.map { |l| l.chomp.wrap wrap_len }.flatten # wrap
 
       ## trim off all empty lines except one
       @lines.pop while @lines.length > 1 && @lines[-1] =~ /^\s*$/ && @lines[-2] =~ /^\s*$/
-- 
1.6.3

