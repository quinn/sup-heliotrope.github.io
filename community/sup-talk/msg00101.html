<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: [sup&#45;talk] Hooks &#45; some examples appreciated -->
<!--X-From-R13: Xvz Qurrgunz <wvzNtbamhy.arg> -->
<!--X-Date: Thu, 22 Nov 2012 13:36:35 &#45;0800 (PST) -->
<!--X-Message-Id: CA+2knqvXGPNx1wSa78RKqSTpbcgHmp&#45;a_MGMGpjV_XOavwNFYg@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 201211221554.08990@inter.netz -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: [sup-talk] Hooks - some examples appreciated</title>
<link rev="made" href="mailto:jim@gonzul.net">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<a href="msg00230.html">Date Prev</a>][<a href="msg00166.html">Date Next</a>][<a href="msg00230.html">Thread Prev</a>][<a href="msg00166.html">Thread Next</a>][<a href="maillist.html#00101">Date Index</a>][<a href="threads.html#00101">Thread Index</a>]
<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [sup-talk] Hooks - some examples appreciated</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: Andre Tann &lt;<a href="mailto:atann%40alphasrv.net">atann@alphasrv.net</a>&gt;</li>
<li><em>Subject</em>: Re: [sup-talk] Hooks - some examples appreciated</li>
<li><em>From</em>: Jim Cheetham &lt;<a href="mailto:jim%40gonzul.net">jim@gonzul.net</a>&gt;</li>
<li><em>Date</em>: Fri, 23 Nov 2012 10:35:54 +1300</li>
<li><em>Authentication-results</em>: mx.google.com; spf=pass (google.com: domain of <a href="mailto:sup-talk-bounces%40rubyforge.org">sup-talk-bounces@rubyforge.org</a> designates 50.56.192.79 as permitted sender) smtp.mail=<a href="mailto:sup-talk-bounces%40rubyforge.org">sup-talk-bounces@rubyforge.org</a></li>
<li><em>Cc</em>: sup-talk &lt;<a href="mailto:sup-talk%40rubyforge.org">sup-talk@rubyforge.org</a>&gt;</li>
<li><em>Delivered-to</em>: <a href="mailto:eg%40gaute.vetsj.com">eg@gaute.vetsj.com</a></li>
<li><em>Delivered-to</em>: <a href="mailto:sup-talk%40rubyforge.org">sup-talk@rubyforge.org</a></li>
<li><em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113;	h=mime-version:sender:in-reply-to:references:from:date	:x-google-sender-auth:message-id:subject:to:cc:content-type	:content-transfer-encoding;	bh=RG4XP5aoRpFUqw454Rk7LU7Ot4zyrch2UqOE7ZcW0HA=;	b=BkfphuzzFGiYSZlCJ4CW5NIlMrAviJlfbqIFuKuoflHZG4s4gkrjfzQiVs6hKdY9Zv	55velRUF5h3xPFgcMTk8PR5vDsind6sxTfOslRExMohbr/NWKVfCHWTf3DCUDLwpxy8b	KLogs+7Z8V4KcrrqPlmu1UnXiMuoM3Ron0QQS/1n8hk3RvPczm7YI6J7LZuX+cwo+cku	HtwtYt9lG5kyw2Dh2EKkGgs1XSlojl0K91/0cEh/SpUYPTVXFwOGF6fUib2GDlP9rDTy	dN7NMeMuyJKcAxfO+B5QXUAbF7Y2NhWhy9KeURCc8BGbbqTHfkLB1UVwQJqhFfMEoCw8	Es9Q==</li>
<li><em>In-reply-to</em>: &lt;<a href="msg00230.html">201211221554.08990@inter.netz</a>&gt;</li>
<li><em>List-archive</em>: &lt;<a href="http://rubyforge.org/pipermail/sup-talk">http://rubyforge.org/pipermail/sup-talk</a>&gt;</li>
<li><em>List-help</em>: &lt;<a href="mailto:sup-talk-request@rubyforge.org?subject=help">mailto:sup-talk-request@rubyforge.org?subject=help</a>&gt;</li>
<li><em>List-id</em>: User &amp; developer discussion of Sup &lt;sup-talk.rubyforge.org&gt;</li>
<li><em>List-post</em>: &lt;<a href="mailto:sup-talk@rubyforge.org">mailto:sup-talk@rubyforge.org</a>&gt;</li>
<li><em>List-subscribe</em>: &lt;<a href="http://rubyforge.org/mailman/listinfo/sup-talk">http://rubyforge.org/mailman/listinfo/sup-talk</a>&gt;,	&lt;<a href="mailto:sup-talk-request@rubyforge.org?subject=subscribe">mailto:sup-talk-request@rubyforge.org?subject=subscribe</a>&gt;</li>
<li><em>List-unsubscribe</em>: &lt;<a href="http://rubyforge.org/mailman/options/sup-talk">http://rubyforge.org/mailman/options/sup-talk</a>&gt;,	&lt;<a href="mailto:sup-talk-request@rubyforge.org?subject=unsubscribe">mailto:sup-talk-request@rubyforge.org?subject=unsubscribe</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg00230.html">201211221554.08990@inter.netz</a>&gt;</li>
<li><em>Sender</em>: <a href="mailto:sup-talk-bounces%40rubyforge.org">sup-talk-bounces@rubyforge.org</a></li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On Fri, Nov 23, 2012 at 3:54 AM, Andre Tann &lt;atann@alphasrv.net&gt; wrote:
&gt; as this Website <a  rel="nofollow" href="http://sup.rubyforge.org/wiki/wiki.pl?Hooks">http://sup.rubyforge.org/wiki/wiki.pl?Hooks</a> is not
&gt; really informative ;) &#x2026; does anybody here have some examples for sup
&gt; hooks?

Sadly the wiki has been almost completely spammed out of existance; it
doesn't store a long-enough revision history to get reverted correctly
any more.

You probably should be doing tagging in before-add.rb

In my before-add hook I was doing a lot of tagging, so much that I
built a small function to help me add and remove tags in one
invocation. A bunch of standard actions help.

First, extract the useful fields -- because a message can have
multiple recipients and I want to check any/all of them (To, Cc, Bcc).
Doing this means I don't have to check the array of recpipents every
time, I can just use string matching on a long flat list of
recipients.

----
# Build up an array of recipients for this message
recipients=[]
message.recipients.each {|rp| recipients &lt;&lt; rp.email }
recips = recipients.join(' ')
----

Then I use a case statement to separate out all the different checks I
want to do:

----
# Nest a set of mutually exclusive cases ...
case
# Nagios messages
        when (message.from.email =~ /nagios@MYDOMAIN/ \
          and recips =~ /MYDOMAIN/) :
                tagit(message,&quot;auto nagios -inbox&quot;)
# Logwatch messages
        when (message.from.email =~ /^logwatch@/ \
          and message.subj =~ /^Logwatch for/) :
                tagit(message,&quot;auto logwatch -inbox&quot;)
# Legato messages
        when message.from.email =~ /^legato@/ :
                tagit(message,&quot;auto legato -inbox&quot;)
----

Those three cases check the sender, adding the tags &quot;auto&quot; and
&quot;nagios&quot;/&quot;logwatch&quot;/&quot;legato&quot; as appropriate, and remove the inbox tag,
so I don't see them in my default view.

I'm using a function &quot;tagit&quot; to do this, it's just a helper function
to make the rules read a little easier. It's defined at the beginning
of my before-add.rb :-

----
def tagit(message,labels)
        actions=[]
        labels.split(' ').each {|l|
                # Check the first character of each label.
                # If it starts with -, remove the label
                # otherwise add it.
                minus=l.match('^-(.*)$')
                if minus
                        message.remove_label minus[1]
                        actions &lt;&lt; &quot;Del #{minus[1]}&quot;
                else
                        message.add_label l
                        actions &lt;&lt; &quot;Add #{l}&quot;
                end
        }
        log &quot;Tagit: #{labels} -&gt; #{message.id} : #{actions.join(',')}&quot;
end
----

Here are a few more tests that I do :-

----
# EDUCAUSE Security
        when message.raw_header =~ /^List-Owner:
&lt;<a  rel="nofollow" href="mailto:SECURITY-request@LISTSERV.EDUCAUSE.EDU">mailto:SECURITY-request@LISTSERV.EDUCAUSE.EDU</a>&gt;$/ :
                tagit(message,&quot;list educause -inbox&quot;)
# rss2email blog messages
        when message.raw_header =~ /X-rss2email/ :
                tagit(message,&quot;blog -inbox&quot;)
                log &quot; blog from #{message.from.inspect}&quot;
                log &quot; blog name #{message.from.name}&quot;
                case message.from.name
                        when /Shipping Container House/
                                tagit(message,&quot;blog.marek&quot;)
                        when /cortesi/
                                tagit(message,&quot;blog.cortesi&quot;)
                        when /RISKS/
                                tagit(message,&quot;blog.risks&quot;)
                        when /WTF/
                                tagit(message,&quot;blog.wtf&quot;)
                        when /Schneier on Security/
                                tagit(message,&quot;blog.schneier&quot;)
                        when /Krebs/
                                tagit(message,&quot;blog.krebs&quot;)
                end
----

So in general I'm looking at these fields :-
* sender address (message.from.email)
* sender name (message.from.name)
* recipient (handy when it's to a list address, using a copy of
message.recipients.each)
* subject (message.subj)
* unusual headers (message.raw_header)

and using decisions based on those to change the tags, using
message.add_label and message.remove_label -- but I'm doing those via
my helper function tagit()

Hope that helps :-)

-jim
_______________________________________________
sup-talk mailing list
sup-talk@rubyforge.org
<a  rel="nofollow" href="http://rubyforge.org/mailman/listinfo/sup-talk">http://rubyforge.org/mailman/listinfo/sup-talk</a>
</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00166" href="msg00166.html">Re: [sup-talk] Hooks - some examples appreciated</a></strong>
<ul><li><em>From:</em> Andre Tann &lt;atann@alphasrv.net&gt;</li></ul></li>
<li><strong><a name="00274" href="msg00274.html">Re: [sup-talk] Hooks - some examples appreciated</a></strong>
<ul><li><em>From:</em> Andre Tann &lt;atann@alphasrv.net&gt;</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00230" href="msg00230.html">[sup-talk] Hooks - some examples appreciated</a></strong>
<ul><li><em>From:</em> Andre Tann &lt;atann@alphasrv.net&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00230.html">[sup-talk] Hooks - some examples appreciated</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00166.html">Re: [sup-talk] Hooks - some examples appreciated</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00230.html">[sup-talk] Hooks - some examples appreciated</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00166.html">Re: [sup-talk] Hooks - some examples appreciated</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#00101"><strong>Date</strong></a></li>
<li><a href="threads.html#00101"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</body>
</html>
