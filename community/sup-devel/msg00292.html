<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: [sup&#45;devel] Experimental Gmail Source -->
<!--X-From-R13: Vbenpvb Enafba <ufnafbaNtznvy.pbz> -->
<!--X-Date: Sat, 1 Jun 2013 19:51:23 &#45;0700 (PDT) -->
<!--X-Message-Id: CAHWBo_acPoWYtBrcd+NTkOit7L7Vx_=Tkxequ&#45;iQimPugWjsJQ@mail.gmail.com -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Reference: CAHWBo_Y6jEWCH8O+m1iw5_p4qd8ghxgvCsa1+15xR7fh+6S0nA@mail.gmail.com -->
<!--X-Reference: 518E1A2B.2080903@gaute.vetsj.com -->
<!--X-Reference: CAHWBo_ZMce1GV=ChkLrSNbz9Lf&#45;DtPb4W479kChXmUFMQf5qpw@mail.gmail.com -->
<!--X-Reference: CAHWBo_ZY7bWTxfqbQ1H3hu&#45;q6mzKZm&#45;YYe&#45;+t0b&#45;0M7xwUDfYQ@mail.gmail.com -->
<!--X-Reference: 1369172802&#45;sup&#45;2003@kpad -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: [sup-devel] Experimental Gmail Source</title>
<link rev="made" href="mailto:hsanson@gmail.com">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<a href="msg00255.html">Date Prev</a>][<a href="msg00082.html">Date Next</a>][<a href="msg00255.html">Thread Prev</a>][<a href="msg00106.html">Thread Next</a>][<a href="maillist.html#00292">Date Index</a>][<a href="threads.html#00292">Thread Index</a>]
<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [sup-devel] Experimental Gmail Source</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: Sup developer discussion &lt;<a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a>&gt;</li>
<li><em>Subject</em>: Re: [sup-devel] Experimental Gmail Source</li>
<li><em>From</em>: Horacio Sanson &lt;<a href="mailto:hsanson%40gmail.com">hsanson@gmail.com</a>&gt;</li>
<li><em>Date</em>: Sun, 2 Jun 2013 11:45:47 +0900</li>
<li><em>Authentication-results</em>: mx.google.com;       spf=pass (google.com: domain of <a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a> designates 50.56.192.79 as permitted sender) smtp.mail=<a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a>;       dkim=neutral (bad format) header.i=@gmail.com</li>
<li><em>Delivered-to</em>: <a href="mailto:eg%40gaute.vetsj.com">eg@gaute.vetsj.com</a></li>
<li><em>Delivered-to</em>: <a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a></li>
<li><em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113;	h=mime-version:in-reply-to:references:date:message-id:subject:from:to	:content-type; bh=TmmvPJaVD2rZk+xmBzQ3inxw1Q4Rvv/dvZEd/iB1Vfc=;	b=DqM70R8BuoGmT58a+5fKHYgm9DR98eKhsbLtrwXaoZ9u1NUKcBLs/b6y89twz4y7Ju	u0yRgxrsWb8jCUZKZ456ST+apLH89yE64GcMnbhy1exqhxAvcGF7HaK0ewMq69kFRV/N	SOEsTGWvhO6liErSaXg23D4DpQeKjwWRRCXC/Dy5SzaASMGVVvU/Xax5zlHzE1nB8nZq	+bCn63QulnJg/l+VI5xFr7u1IUpu2onQXky16jk8825KcoNzhCk2EE3R69Z1MpPJN7u5	voze+islzheU3WBdT6cRxi8ZYsSEhi+6aRiwMawIsrYh8gFvDLhWGmj1tUKb4HmTFvaC	0NRw==</li>
<li><em>In-reply-to</em>: &lt;1369172802-sup-2003@kpad&gt;</li>
<li><em>List-archive</em>: &lt;<a href="http://rubyforge.org/pipermail/sup-devel">http://rubyforge.org/pipermail/sup-devel</a>&gt;</li>
<li><em>List-help</em>: &lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=help">mailto:sup-devel-request@rubyforge.org?subject=help</a>&gt;</li>
<li><em>List-id</em>: Sup developer discussion &lt;sup-devel.rubyforge.org&gt;</li>
<li><em>List-post</em>: &lt;<a href="mailto:sup-devel@rubyforge.org">mailto:sup-devel@rubyforge.org</a>&gt;</li>
<li><em>List-subscribe</em>: &lt;<a href="http://rubyforge.org/mailman/listinfo/sup-devel">http://rubyforge.org/mailman/listinfo/sup-devel</a>&gt;,	&lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=subscribe">mailto:sup-devel-request@rubyforge.org?subject=subscribe</a>&gt;</li>
<li><em>List-unsubscribe</em>: &lt;<a href="http://rubyforge.org/mailman/options/sup-devel">http://rubyforge.org/mailman/options/sup-devel</a>&gt;,	&lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=unsubscribe">mailto:sup-devel-request@rubyforge.org?subject=unsubscribe</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg00218.html">CAHWBo_Y6jEWCH8O+m1iw5_p4qd8ghxgvCsa1+15xR7fh+6S0nA@mail.gmail.com</a>&gt;	&lt;<a href="msg00206.html">518E1A2B.2080903@gaute.vetsj.com</a>&gt;	&lt;CAHWBo_ZMce1GV=ChkLrSNbz9Lf-DtPb4W479kChXmUFMQf5qpw@mail.gmail.com&gt;	&lt;<a href="msg00052.html">CAHWBo_ZY7bWTxfqbQ1H3hu-q6mzKZm-YYe-+t0b-0M7xwUDfYQ@mail.gmail.com</a>&gt;	&lt;1369172802-sup-2003@kpad&gt;</li>
<li><em>Reply-to</em>: Sup developer discussion &lt;<a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a>&gt;</li>
<li><em>Sender</em>: <a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a></li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<div dir="ltr">Thanks for checking the source and sorry for the late response... I can only look into this on rare free weekends.<br><div class="gmail_extra"><br><br><div class="gmail_quote">On Wed, May 22, 2013 at 6:47 AM, Matthieu Rakotojaona <span dir="ltr">&lt;<a rel="nofollow" href="mailto:matthieu.rakotojaona@gmail.com" target="_blank">matthieu.rakotojaona@gmail.com</a>&gt;</span> wrote:<br>

<blockquote class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex">Hey Horacio,<br>
<br>
I took a stab at your gmail_source branch, and made a few<br>
fixes/improvements [0]:<br>
<br>
- Add configuration option in sup-add<br>
- Dump the LevelDB path in the sources.yaml<br>
- Add a load_from_yaml method for a source to initialize its working<br>
&#xA0; values (for instance, the @db cannot be serialized, it needs to be<br>
&#xA0; reconstructed)<br>
- Fixed the msg_att monkey-patch for imap.rb<br>
<br></blockquote><div><br></div><div>Great, I will add these changes to my branch....</div><div>&#xA0;</div><blockquote class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex">

All in all, the gmail source seems to work. I tested it on my usual<br>
gmail account, I haven&#39;t tried to download it all, but I did download a<br>
few dozens of emails without a problem. I&#39;d like to warn users about<br>
LevelDB though: it&#39;s sad to say, but as other wmorgan&#39;s stuff, it looks<br>
abandoned. There are at least 2 bugs you will encounter if you try it: a<br>
pb in configuration (fixed in [1]) and you need the `snappy` gem to make<br>
it work if your db is more than 4MB large [2]. There are some up-to-date<br>
forks, though.</blockquote><div>&#xA0;</div><blockquote class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex">&#xA0;<br></blockquote>
<blockquote class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex">

I see LevelDB is used mostly for storing messages and mailboxes<br>
uid{validity/last}, but if we are to use gmail (it&#39;s the only IMAP<br>
provider that makes sense for sup), I believe we would stick to the All<br>
Mail label, right ? So, no need for storing this in db, rather in the<br>
sources.yaml file. Also, if leveldb-ruby is unreliable (I did encounter<br>
some issues way back about something with glibc...), and we want to use<br>
it for caching messages, I think we can salvage heliotrope&#39;s zmbox [3]<br>
because it&#39;s so simple to use yet far better than simple mbox.</blockquote><div><br></div><div>Using zmbox, mbox, maildir or any other mail storage (mix?) means I need to keep track of three indexes to allow two way sync between the Gmail source and the Sup index. I would need the Sup index id, the store id (e.g. zmbox file index) and the Gmail X-GM-MSGID. That complicates things a lot.</div>
<div><br></div><div style>Using key/value stores like LevelDB allows me to directly store the messages and associate them directly with the Gmail X-GM-MSGID. Also LevelDB comes with high compression for text data, perfect for emails, and high performance [1]. The issues you mention seem to be on the ruby library rather than LevelDB itself and they are fixable. If there are no bigger issues (e.g. data corruption/loss) I will stick with LevelDB.</div>
<div><br></div><blockquote class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex">
Regarding your ids questions, if you want to access the sup&#39;s messages<br>
from the gmail source, you could use the mail&#39;s Message-ID header and<br>
apply the same logic as in Message.sanitize_message_id. Caution,<br>
however: I&#39;ve already encountered the case where multiple messages in<br>
GMail (i.e multiple X-GM-MSGID) have the same Message-ID, so they would<br>
be considered the same in sup/heliotrope... yeah, that&#39;s annoying as<br>
hell, and I don&#39;t know how we can solve this in the case of multiple<br>
sources.<br>
<br></blockquote><div><br></div><div style>Thanks, this comment put me on track and I found a way to get the emails from the index using the message id provided by the source. All I need to do is call Message.build_from_source(source, info) where info is the message id provided by the source. In my case this would be the X-GM-MSGID string.</div>
<div style><br></div><blockquote class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex">
If you want to sync-back, maybe sup can call a source-level &quot;sync_back&quot;<br>
method with the current known state ? Speaking of which, for general<br>
synchronization we could reuse the elegant offlineimap&#39;s sync algorithm<br>
[4]. The idea is basic: have each source class store a snapshot of the<br>
state. &#xA0;When a message is modified on the source, diff the change with<br>
the known status and propagate to sup; when a message is modified in<br>
sup, diff with the known status and propagate to the source.<br>
<br></blockquote><div><br></div><div style>Interesting and simple algorithm. Let me study it a little more and see how it is applicable to Sup.&#xA0;</div><div><br></div><div>[1] &#xA0;<a rel="nofollow" href="http://leveldb.googlecode.com/svn/trunk/doc/benchmark.html">http://leveldb.googlecode.com/svn/trunk/doc/benchmark.html</a></div>
<div><br></div><div style>regards,</div><div style>Horacio</div><div><br></div><blockquote class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex">

Just a brain dump.<br>
<br>
[0] <a rel="nofollow" href="https://github.com/rakoo/sup/tree/gmail_source" target="_blank">https://github.com/rakoo/sup/tree/gmail_source</a><br>
[1] <a rel="nofollow" href="https://github.com/wmorgan/leveldb-ruby/pull/27" target="_blank">https://github.com/wmorgan/leveldb-ruby/pull/27</a><br>
[2] <a rel="nofollow" href="https://github.com/wmorgan/leveldb-ruby/issues/23" target="_blank">https://github.com/wmorgan/leveldb-ruby/issues/23</a><br>
[3] <a rel="nofollow" href="https://github.com/sup-heliotrope/heliotrope/blob/64d4b50d5649ec616a311a4cf6955137fdaeb13d/lib/heliotrope/zmbox.rb" target="_blank">https://github.com/sup-heliotrope/heliotrope/blob/64d4b50d5649ec616a311a4cf6955137fdaeb13d/lib/heliotrope/zmbox.rb</a><br>


[4] <a rel="nofollow" href="http://offlineimap.org/howitworks.html" target="_blank">http://offlineimap.org/howitworks.html</a><br>
<br>
Regards,<br>
<span><font color="#888888"><br>
--<br>
Matthieu Rakotojaona<br>
</font></span><br>_______________________________________________<br>
Sup-devel mailing list<br>
<a rel="nofollow" href="mailto:Sup-devel@rubyforge.org" target="_blank">Sup-devel@rubyforge.org</a><br>
<a rel="nofollow" href="http://rubyforge.org/mailman/listinfo/sup-devel" target="_blank">http://rubyforge.org/mailman/listinfo/sup-devel</a><br>
<br></blockquote></div><br></div></div>
<pre>_______________________________________________
Sup-devel mailing list
Sup-devel@rubyforge.org
<a  rel="nofollow" href="http://rubyforge.org/mailman/listinfo/sup-devel">http://rubyforge.org/mailman/listinfo/sup-devel</a>
</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00218" href="msg00218.html">[sup-devel] Experimental Gmail Source</a></strong>
<ul><li><em>From:</em> Horacio Sanson &lt;hsanson@gmail.com&gt;</li></ul></li>
<li><strong><a name="00206" href="msg00206.html">Re: [sup-devel] Experimental Gmail Source</a></strong>
<ul><li><em>From:</em> Gaute Hope &lt;eg@gaute.vetsj.com&gt;</li></ul></li>
<li><strong><a name="00317" href="msg00317.html">Re: [sup-devel] Experimental Gmail Source</a></strong>
<ul><li><em>From:</em> Horacio Sanson &lt;hsanson@gmail.com&gt;</li></ul></li>
<li><strong><a name="00052" href="msg00052.html">Re: [sup-devel] Experimental Gmail Source</a></strong>
<ul><li><em>From:</em> Horacio Sanson &lt;hsanson@gmail.com&gt;</li></ul></li>
<li><strong><a name="00255" href="msg00255.html">Re: [sup-devel] Experimental Gmail Source</a></strong>
<ul><li><em>From:</em> Matthieu Rakotojaona &lt;matthieu.rakotojaona@gmail.com&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00255.html">Re: [sup-devel] Experimental Gmail Source</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00082.html">going for 0.13.1 and possibly 0.14?</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00255.html">Re: [sup-devel] Experimental Gmail Source</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00106.html">[sup-devel] How to get labels from sup for a specific message id?</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#00292"><strong>Date</strong></a></li>
<li><a href="threads.html#00292"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</body>
</html>
