<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: [sup&#45;devel] Experimental Gmail Source -->
<!--X-From-R13: [ngguvrh Dnxbgbwnban <zngguvrh.enxbgbwnbanNtznvy.pbz> -->
<!--X-Date: Tue, 21 May 2013 14:55:53 &#45;0700 (PDT) -->
<!--X-Message-Id: 1369172802&#45;sup&#45;2003@kpad -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Reference: CAHWBo_Y6jEWCH8O+m1iw5_p4qd8ghxgvCsa1+15xR7fh+6S0nA@mail.gmail.com -->
<!--X-Reference: 518E1A2B.2080903@gaute.vetsj.com -->
<!--X-Reference: CAHWBo_ZMce1GV=ChkLrSNbz9Lf&#45;DtPb4W479kChXmUFMQf5qpw@mail.gmail.com -->
<!--X-Reference: CAHWBo_ZY7bWTxfqbQ1H3hu&#45;q6mzKZm&#45;YYe&#45;+t0b&#45;0M7xwUDfYQ@mail.gmail.com -->
<!--X-Derived: pgpjDbAGqQayN.pgp -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: [sup-devel] Experimental Gmail Source</title>
<link rev="made" href="mailto:matthieu.rakotojaona@gmail.com">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<a href="msg00253.html">Date Prev</a>][<a href="msg00292.html">Date Next</a>][<a href="msg00052.html">Thread Prev</a>][<a href="msg00292.html">Thread Next</a>][<a href="maillist.html#00255">Date Index</a>][<a href="threads.html#00255">Thread Index</a>]
<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [sup-devel] Experimental Gmail Source</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: sup-devel &lt;<a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a>&gt;</li>
<li><em>Subject</em>: Re: [sup-devel] Experimental Gmail Source</li>
<li><em>From</em>: Matthieu Rakotojaona &lt;<a href="mailto:matthieu.rakotojaona%40gmail.com">matthieu.rakotojaona@gmail.com</a>&gt;</li>
<li><em>Date</em>: Tue, 21 May 2013 23:47:16 +0200</li>
<li><em>Authentication-results</em>: mx.google.com;       spf=pass (google.com: domain of <a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a> designates 50.56.192.79 as permitted sender) smtp.mail=<a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a>;       dkim=neutral (bad format) header.i=@gmail.com</li>
<li><em>Delivered-to</em>: <a href="mailto:eg%40gaute.vetsj.com">eg@gaute.vetsj.com</a></li>
<li><em>Delivered-to</em>: <a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a></li>
<li><em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113;	h=from:to:subject:in-reply-to:references:x-pgp-key:date:message-id	:user-agent:content-transfer-encoding:mime-version:content-type;	bh=jaSbBxANeIR6thaTdS0IJpHwbMSDTjt4qWwoRvUPLEI=;	b=xVJlNGI8o5uus60AAqm86+6v33QgdEm94ceYQvw02uSRcwn2XVy9FQr9mEcs10EfCJ	8sZQcM0808BFqS5/QDwATk6I2XSNo+ySF71ggWVU7lB8e6DUZXJuW/YsH8TWJZ6YVi0x	QxWydU6c7MsWF0XarE4NgN5CfzNsG7qPMJ+JpTCa8yXYPyjWIzRGpLQ3OYrpnSqBXqtv	lCqwH6/ycgpUrc3+CqWFTacAFXenPPaIjS6F6YlqMfjlzpchB8HZwEbiavZfF4PrBEJP	F5MCQyIbL9AjJdddl+sgiSm2gB0UqMGwG0dlNkxVxNaU5clMJ8OWEwiWdF5LCQ7AgBDX	Oo3Q==</li>
<li><em>In-reply-to</em>: &lt;<a href="msg00052.html">CAHWBo_ZY7bWTxfqbQ1H3hu-q6mzKZm-YYe-+t0b-0M7xwUDfYQ@mail.gmail.com</a>&gt;</li>
<li><em>List-archive</em>: &lt;<a href="http://rubyforge.org/pipermail/sup-devel">http://rubyforge.org/pipermail/sup-devel</a>&gt;</li>
<li><em>List-help</em>: &lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=help">mailto:sup-devel-request@rubyforge.org?subject=help</a>&gt;</li>
<li><em>List-id</em>: Sup developer discussion &lt;sup-devel.rubyforge.org&gt;</li>
<li><em>List-post</em>: &lt;<a href="mailto:sup-devel@rubyforge.org">mailto:sup-devel@rubyforge.org</a>&gt;</li>
<li><em>List-subscribe</em>: &lt;<a href="http://rubyforge.org/mailman/listinfo/sup-devel">http://rubyforge.org/mailman/listinfo/sup-devel</a>&gt;,	&lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=subscribe">mailto:sup-devel-request@rubyforge.org?subject=subscribe</a>&gt;</li>
<li><em>List-unsubscribe</em>: &lt;<a href="http://rubyforge.org/mailman/options/sup-devel">http://rubyforge.org/mailman/options/sup-devel</a>&gt;,	&lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=unsubscribe">mailto:sup-devel-request@rubyforge.org?subject=unsubscribe</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg00218.html">CAHWBo_Y6jEWCH8O+m1iw5_p4qd8ghxgvCsa1+15xR7fh+6S0nA@mail.gmail.com</a>&gt;	&lt;<a href="msg00206.html">518E1A2B.2080903@gaute.vetsj.com</a>&gt;	&lt;CAHWBo_ZMce1GV=ChkLrSNbz9Lf-DtPb4W479kChXmUFMQf5qpw@mail.gmail.com&gt;	&lt;<a href="msg00052.html">CAHWBo_ZY7bWTxfqbQ1H3hu-q6mzKZm-YYe-+t0b-0M7xwUDfYQ@mail.gmail.com</a>&gt;</li>
<li><em>Reply-to</em>: Sup developer discussion &lt;<a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a>&gt;</li>
<li><em>Sender</em>: <a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a></li>
<li><em>User-agent</em>: Sup/git</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Hey Horacio,

I took a stab at your gmail_source branch, and made a few
fixes/improvements [0]:

- Add configuration option in sup-add
- Dump the LevelDB path in the sources.yaml
- Add a load_from_yaml method for a source to initialize its working
  values (for instance, the @db cannot be serialized, it needs to be
  reconstructed)
- Fixed the msg_att monkey-patch for imap.rb

All in all, the gmail source seems to work. I tested it on my usual
gmail account, I haven't tried to download it all, but I did download a
few dozens of emails without a problem. I'd like to warn users about
LevelDB though: it's sad to say, but as other wmorgan's stuff, it looks
abandoned. There are at least 2 bugs you will encounter if you try it: a
pb in configuration (fixed in [1]) and you need the `snappy` gem to make
it work if your db is more than 4MB large [2]. There are some up-to-date
forks, though.

I see LevelDB is used mostly for storing messages and mailboxes
uid{validity/last}, but if we are to use gmail (it's the only IMAP
provider that makes sense for sup), I believe we would stick to the All
Mail label, right ? So, no need for storing this in db, rather in the
sources.yaml file. Also, if leveldb-ruby is unreliable (I did encounter
some issues way back about something with glibc...), and we want to use
it for caching messages, I think we can salvage heliotrope's zmbox [3]
because it's so simple to use yet far better than simple mbox.

Regarding your ids questions, if you want to access the sup's messages
from the gmail source, you could use the mail's Message-ID header and
apply the same logic as in Message.sanitize_message_id. Caution,
however: I've already encountered the case where multiple messages in
GMail (i.e multiple X-GM-MSGID) have the same Message-ID, so they would
be considered the same in sup/heliotrope... yeah, that's annoying as
hell, and I don't know how we can solve this in the case of multiple
sources.

If you want to sync-back, maybe sup can call a source-level &quot;sync_back&quot;
method with the current known state ? Speaking of which, for general
synchronization we could reuse the elegant offlineimap's sync algorithm
[4]. The idea is basic: have each source class store a snapshot of the
state.  When a message is modified on the source, diff the change with
the known status and propagate to sup; when a message is modified in
sup, diff with the known status and propagate to the source.

Just a brain dump.

[0] <a  rel="nofollow" href="https://github.com/rakoo/sup/tree/gmail_source">https://github.com/rakoo/sup/tree/gmail_source</a>
[1] <a  rel="nofollow" href="https://github.com/wmorgan/leveldb-ruby/pull/27">https://github.com/wmorgan/leveldb-ruby/pull/27</a>
[2] <a  rel="nofollow" href="https://github.com/wmorgan/leveldb-ruby/issues/23">https://github.com/wmorgan/leveldb-ruby/issues/23</a>
[3] <a  rel="nofollow" href="https://github.com/sup-heliotrope/heliotrope/blob/64d4b50d5649ec616a311a4cf6955137fdaeb13d/lib/heliotrope/zmbox.rb">https://github.com/sup-heliotrope/heliotrope/blob/64d4b50d5649ec616a311a4cf6955137fdaeb13d/lib/heliotrope/zmbox.rb</a>
[4] <a  rel="nofollow" href="http://offlineimap.org/howitworks.html">http://offlineimap.org/howitworks.html</a>

Regards,

-- 
Matthieu Rakotojaona
</pre><p><strong>Attachment:
<a href="pgpjDbAGqQayN.pgp" ><tt>signature.asc</tt></a></strong><br>
<em>Description:</em> PGP signature</p>
<pre>_______________________________________________
Sup-devel mailing list
Sup-devel@rubyforge.org
<a  rel="nofollow" href="http://rubyforge.org/mailman/listinfo/sup-devel">http://rubyforge.org/mailman/listinfo/sup-devel</a>
</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00292" href="msg00292.html">Re: [sup-devel] Experimental Gmail Source</a></strong>
<ul><li><em>From:</em> Horacio Sanson &lt;hsanson@gmail.com&gt;</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00218" href="msg00218.html">[sup-devel] Experimental Gmail Source</a></strong>
<ul><li><em>From:</em> Horacio Sanson &lt;hsanson@gmail.com&gt;</li></ul></li>
<li><strong><a name="00206" href="msg00206.html">Re: [sup-devel] Experimental Gmail Source</a></strong>
<ul><li><em>From:</em> Gaute Hope &lt;eg@gaute.vetsj.com&gt;</li></ul></li>
<li><strong><a name="00317" href="msg00317.html">Re: [sup-devel] Experimental Gmail Source</a></strong>
<ul><li><em>From:</em> Horacio Sanson &lt;hsanson@gmail.com&gt;</li></ul></li>
<li><strong><a name="00052" href="msg00052.html">Re: [sup-devel] Experimental Gmail Source</a></strong>
<ul><li><em>From:</em> Horacio Sanson &lt;hsanson@gmail.com&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00253.html">Re: [sup-devel] sup 0.13</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00292.html">Re: [sup-devel] Experimental Gmail Source</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00052.html">Re: [sup-devel] Experimental Gmail Source</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00292.html">Re: [sup-devel] Experimental Gmail Source</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#00255"><strong>Date</strong></a></li>
<li><a href="threads.html#00255"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</body>
</html>
