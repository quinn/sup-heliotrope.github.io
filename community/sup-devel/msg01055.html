<!-- MHonArc v2.6.18 -->
<!--X-Subject: [sup&#45;devel] Adding backward synchronization for Maildir sources -->
<!--X-From-R13: Rnzvra Zrbar <qnzvra.yrbarNsrafnyve.se> -->
<!--X-Date: Fri, 9 Jul 2010 09:44:25 &#45;0700 (PDT) -->
<!--X-Message-Id: 1278693172&#45;sup&#45;6247@mailer -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Derived: pgpf7MASUN7NZ.pgp -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>[sup-devel] Adding backward synchronization for Maildir sources</title>
<link rev="made" href="mailto:damien.leone@fensalir.fr">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<a href="msg01145.html">Date Prev</a>][<a href="msg00921.html">Date Next</a>][<a href="msg00970.html">Thread Prev</a>][<a href="msg00921.html">Thread Next</a>][<a href="maillist.html#01055">Date Index</a>][<a href="threads.html#01055">Thread Index</a>]
<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>[sup-devel] Adding backward synchronization for Maildir sources</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: sup-devel &lt;<a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a>&gt;</li>
<li><em>Subject</em>: [sup-devel] Adding backward synchronization for Maildir sources</li>
<li><em>From</em>: Damien Leone &lt;<a href="mailto:damien.leone%40fensalir.fr">damien.leone@fensalir.fr</a>&gt;</li>
<li><em>Date</em>: Fri, 09 Jul 2010 18:44:01 +0200</li>
<li><em>Authentication-results</em>: mx.google.com; spf=pass (google.com: domain of <a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a> designates 205.234.109.19 as permitted sender) smtp.mail=<a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a>; dkim=neutral (body hash did not verify) header.i=@gmail.com</li>
<li><em>Delivered-to</em>: <a href="mailto:eg%40gaute.vetsj.com">eg@gaute.vetsj.com</a></li>
<li><em>Delivered-to</em>: <a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a></li>
<li><em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=gamma;	h=domainkey-signature:received:received:sender:subject:from:to:date	:message-id:user-agent:content-transfer-encoding:content-type	:mime-version; bh=a1rEi0iX393F6HOLVL8hZ7zesVC9x2XPiiEN3WwRkT4=;	b=QZEwUOmzT71dwaRWNBpXC6n6in6zs/zi1nONHty1FoOEEHzsalR7nouUT3ZfZ/OZZ+	LzmlKt6MFpcwpxVOldqXd6XhlDNMA6fCuNZpR8m0grMH2/MNFV0T0jRMbMrrtKtAGyFV	dEvucCMlR79xV4ukxNq6/x9/M27A+/LFpJYUE=</li>
<li><em>Domainkey-signature</em>: a=rsa-sha1; c=nofws; d=gmail.com; s=gamma;	h=sender:subject:from:to:date:message-id:user-agent	:content-transfer-encoding:content-type:mime-version;	b=hHm/422M55+ePwGrjAwAl/yUWqoCh6MqqXnISBCRkCXToOMgMRVl8FfvMF6QCEwUBk	anIF7GvcQ6hIOw6qTZhficqOZnxuS5Vl96fK7KNcz2n8TeZCm0d35mTlwEteC5KQUI1F	tHXZ/LLcu3J42W0MiRm9Inf3vPqEqTPeu4FFk=</li>
<li><em>List-archive</em>: &lt;<a href="http://rubyforge.org/pipermail/sup-devel">http://rubyforge.org/pipermail/sup-devel</a>&gt;</li>
<li><em>List-help</em>: &lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=help">mailto:sup-devel-request@rubyforge.org?subject=help</a>&gt;</li>
<li><em>List-id</em>: Sup developer discussion &lt;sup-devel.rubyforge.org&gt;</li>
<li><em>List-post</em>: &lt;<a href="mailto:sup-devel@rubyforge.org">mailto:sup-devel@rubyforge.org</a>&gt;</li>
<li><em>List-subscribe</em>: &lt;<a href="http://rubyforge.org/mailman/listinfo/sup-devel">http://rubyforge.org/mailman/listinfo/sup-devel</a>&gt;,	&lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=subscribe">mailto:sup-devel-request@rubyforge.org?subject=subscribe</a>&gt;</li>
<li><em>List-unsubscribe</em>: &lt;<a href="http://rubyforge.org/mailman/options/sup-devel">http://rubyforge.org/mailman/options/sup-devel</a>&gt;,	&lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=unsubscribe">mailto:sup-devel-request@rubyforge.org?subject=unsubscribe</a>&gt;</li>
<li><em>Reply-to</em>: Sup developer discussion &lt;<a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a>&gt;</li>
<li><em>Sender</em>: <a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a></li>
<li><em>User-agent</em>: Sup/git</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Sup guys,

I have been working on backward synchronization for Maildir sources
last week and I need your help to test and review the code.

I pushed my commits (based on the 'next' branch) to my repo which you
can find here [0] for the web interface and here [1] for the git
address.

The following is related to Maildir sources ONLY.

So what does work and what does not (if you don't want to read this,
scroll to the quick howto below):

- Sup will now stay synchronized with your remote sources by detecting
if a message has been remotely updated (ie: you change a flag from
another client), these updates will be applied to your local index and
your thread-view-mode buffers should be properly refreshed;

- When a message is remotely deleted, it should now disappear from
your index;

- There is a new configuration option called &quot;sync_back_to_maildir&quot;
which is false by default. When true, this option updates your actual
Maildir files when you change a label, this is done in real time
before being saved to xapian. So for instance if you use offlineimap
the changes should be synched back to your IMAP server by the next
poll in Sup (assuming that your before-poll hook runs offlineimap);

- I wrote a &quot;sup-sync-back-maildir&quot; script that will synchronize all
messages from your sources at once. This should be executed the first
time BEFORE any polling, otherwise your IMAP server will be synched to
your Sup index and if you did not used another client to mark your
emails as read etc. (like me) and to update your IMAP server then you
will lose all what you did in Sup (labels, etc.);

- I added two new hidden labels in Sup: 'replied' and 'forwarded',
they are automatically added when replying, forwarding or bouncing a
message, this is to bring a better Maildir support to Sup, this should
be invisible for users;

- However you will probably lose all your remote 'replied' and
'forwarded' flags after your first backward synchronization to Maildir
since Sup dropped these labels when it added your messages to xapian.

- Moving a message from a Maildir source to another is not (yet?)
supported.

So, you should now be able to use multiple clients to handle your
emails, for instance I can use gmail to mark messages as starred or
so, it will be reflected in Sup. In the same way, if I mark a message
as read in Sup it will appear as read in the gmail web interface.

I tested this code with my main account (2 GB and like 15 Maildir
sources) it works fine so far.

Be warned that it is highly experimental, but if you use offlineimap
it has a realdelete option so you *should* not lose any email, in the
worst case it might mess your flags/labels up.

I tested it only with offlineimap working with a gmail account.

Quick howto:

1. Close sup
2. Backup your emails and your xapian index or use another Sup session
3. Clone the branch [1]
4. IMPORTANT: run &quot;bin/sup-sync-back-maildir&quot; to synchronize the
   Maildirs you wish, check the help
5. Add &quot;:sync_back_to_maildir: true&quot; to your config.yaml
6. Run and use sup

Please test it and make reviews! :)

NOTE: if you want this to work, get sure that you are not calling
offlineimap with the '-q' option (as suggested in the wiki) otherwise
it will ignore the flag updates on IMAP server, so check your
before-poll hook.

[0] <a  rel="nofollow" href="http://git.fensalir.fr/?p=dleone/sup.git">http://git.fensalir.fr/?p=dleone/sup.git</a>
[1] $ git clone git://fensalir.fr/dleone/sup.git -b maildir-sync

--
Damien Leone &lt;damien.leone@fensalir.fr&gt;

Web: <a  rel="nofollow" href="http://dleone.fensalir.fr/">http://dleone.fensalir.fr/</a>
GPG: 0x82EB4DDF
</pre><p><strong>Attachment:
<a href="pgpf7MASUN7NZ.pgp" ><tt>signature.asc</tt></a></strong><br>
<em>Description:</em> PGP signature</p>
<pre>_______________________________________________
Sup-devel mailing list
Sup-devel@rubyforge.org
<a  rel="nofollow" href="http://rubyforge.org/mailman/listinfo/sup-devel">http://rubyforge.org/mailman/listinfo/sup-devel</a>
</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00921" href="msg00921.html">Re: [sup-devel] Adding backward synchronization for Maildir sources</a></strong>
<ul><li><em>From:</em> &quot;Edward Z. Yang&quot; &lt;ezyang@MIT.EDU&gt;</li></ul></li>
<li><strong><a name="00784" href="msg00784.html">Re: [sup-devel] Adding backward synchronization for Maildir sources</a></strong>
<ul><li><em>From:</em> Damien Leone &lt;damien.leone@fensalir.fr&gt;</li></ul></li>
<li><strong><a name="00968" href="msg00968.html">Re: [sup-devel] Adding backward synchronization for Maildir sources</a></strong>
<ul><li><em>From:</em> &quot;Edward Z. Yang&quot; &lt;ezyang@MIT.EDU&gt;</li></ul></li>
<li><strong><a name="01057" href="msg01057.html">Re: [sup-devel] Adding backward synchronization for Maildir sources</a></strong>
<ul><li><em>From:</em> &quot;Edward Z. Yang&quot; &lt;ezyang@MIT.EDU&gt;</li></ul></li>
<li><strong><a name="00940" href="msg00940.html">Re: [sup-devel] Adding backward synchronization for Maildir sources</a></strong>
<ul><li><em>From:</em> &quot;Edward Z. Yang&quot; &lt;ezyang@MIT.EDU&gt;</li></ul></li>
<li><strong><a name="01108" href="msg01108.html">Re: [sup-devel] Adding backward synchronization for Maildir sources</a></strong>
<ul><li><em>From:</em> Rich Lane &lt;rlane@club.cc.cmu.edu&gt;</li></ul></li>
<li><strong><a name="00703" href="msg00703.html">Re: [sup-devel] Adding backward synchronization for Maildir sources</a></strong>
<ul><li><em>From:</em> Damien Leone &lt;damien.leone@fensalir.fr&gt;</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg01145.html">[sup-devel] [PATCH] don't leak fds for mbox sources</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00921.html">Re: [sup-devel] Adding backward synchronization for Maildir sources</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00970.html">Re: [sup-devel] [PATCH] fix crash during poll if Maildir has been	emptied</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00921.html">Re: [sup-devel] Adding backward synchronization for Maildir sources</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#01055"><strong>Date</strong></a></li>
<li><a href="threads.html#01055"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</body>
</html>
