<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: [sup&#45;devel] Query for largest msg_id? -->
<!--X-From-R13: Vbenpvb Enafba <ufnafbaNtznvy.pbz> -->
<!--X-Date: Tue, 17 May 2011 08:16:58 &#45;0700 (PDT) -->
<!--X-Message-Id: BANLkTinBWgd2NYZqT+y8oHt9&#45;_aiRjdcNA@mail.gmail.com -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Reference: BANLkTi=bSNyp+8XFCRpYGojuM8Ub5PjB2A@mail.gmail.com -->
<!--X-Reference: 1305471101&#45;sup&#45;6655@masanjin.net -->
<!--X-Reference: BANLkTin5eRZw44Je+==V=K4pyVw2T7S3+A@mail.gmail.com -->
<!--X-Derived: bin3fwdvsGE6s.bin -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: [sup-devel] Query for largest msg_id?</title>
<link rev="made" href="mailto:hsanson@gmail.com">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<a href="msg00044.html">Date Prev</a>][<a href="msg00308.html">Date Next</a>][<a href="msg00126.html">Thread Prev</a>][<a href="msg00044.html">Thread Next</a>][<a href="maillist.html#00199">Date Index</a>][<a href="threads.html#00199">Thread Index</a>]
<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [sup-devel] Query for largest msg_id?</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: Sup developer discussion &lt;<a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a>&gt;</li>
<li><em>Subject</em>: Re: [sup-devel] Query for largest msg_id?</li>
<li><em>From</em>: Horacio Sanson &lt;<a href="mailto:hsanson%40gmail.com">hsanson@gmail.com</a>&gt;</li>
<li><em>Date</em>: Tue, 17 May 2011 23:59:34 +0900</li>
<li><em>Authentication-results</em>: mx.google.com; spf=pass (google.com: domain of <a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a> designates 205.234.109.19 as permitted sender) smtp.mail=<a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a>; dkim=neutral (body hash did not verify) header.i=@gmail.com</li>
<li><em>Delivered-to</em>: <a href="mailto:eg%40gaute.vetsj.com">eg@gaute.vetsj.com</a></li>
<li><em>Delivered-to</em>: <a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a></li>
<li><em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=gamma;	h=domainkey-signature:mime-version:in-reply-to:references:date	:message-id:subject:from:to:content-type;	bh=IwVNhmnLrS2kvScT35M6xYUhncmMBCb2HmJW1LGk8UI=;	b=BZ5jxvwK3uSRgPlnKm5v6Tsu2c07K0xT0D3/4R9aKMP4hsY/zr1uYgNSQ6+uzvO1C7	oC+Edo6e8b9qgRBWckIMF0uAgPLw12/vLJwlvnsNf6sraXYIwr2sQdXtpTkFZdasnIl1	rZPoJz4YZG+dlrSw3Ewm0ep+5jVXZc8Pz6Yq4=</li>
<li><em>Domainkey-signature</em>: a=rsa-sha1; c=nofws; d=gmail.com; s=gamma;	h=mime-version:in-reply-to:references:date:message-id:subject:from:to	:content-type;	b=Svo2kX4tQGM/bNMthzIwqKUt2mo5j1iwtlJAKxd4Rca1I089F6s1KQWkiPUemCqB9m	pCG1oPB8FIP1aERZbLMYD9NUymtKhAcht35aOlACoJMSb8vhxNyfLGTLob1jdn/4duaJ	LllYS2jtJvYrljWaOjQqHRdMzYHGFKAURv4zo=</li>
<li><em>In-reply-to</em>: &lt;BANLkTin5eRZw44Je+==V=K4pyVw2T7S3+A@mail.gmail.com&gt;</li>
<li><em>List-archive</em>: &lt;<a href="http://rubyforge.org/pipermail/sup-devel">http://rubyforge.org/pipermail/sup-devel</a>&gt;</li>
<li><em>List-help</em>: &lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=help">mailto:sup-devel-request@rubyforge.org?subject=help</a>&gt;</li>
<li><em>List-id</em>: Sup developer discussion &lt;sup-devel.rubyforge.org&gt;</li>
<li><em>List-post</em>: &lt;<a href="mailto:sup-devel@rubyforge.org">mailto:sup-devel@rubyforge.org</a>&gt;</li>
<li><em>List-subscribe</em>: &lt;<a href="http://rubyforge.org/mailman/listinfo/sup-devel">http://rubyforge.org/mailman/listinfo/sup-devel</a>&gt;,	&lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=subscribe">mailto:sup-devel-request@rubyforge.org?subject=subscribe</a>&gt;</li>
<li><em>List-unsubscribe</em>: &lt;<a href="http://rubyforge.org/mailman/options/sup-devel">http://rubyforge.org/mailman/options/sup-devel</a>&gt;,	&lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=unsubscribe">mailto:sup-devel-request@rubyforge.org?subject=unsubscribe</a>&gt;</li>
<li><em>References</em>: &lt;BANLkTi=bSNyp+8XFCRpYGojuM8Ub5PjB2A@mail.gmail.com&gt;	&lt;<a href="msg00313.html">1305471101-sup-6655@masanjin.net</a>&gt;	&lt;BANLkTin5eRZw44Je+==V=K4pyVw2T7S3+A@mail.gmail.com&gt;</li>
<li><em>Reply-to</em>: Sup developer discussion &lt;<a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a>&gt;</li>
<li><em>Sender</em>: <a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a></li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>I implemented a new version of the GMail -&gt; Heliotrope sync script and
attach it here in hopes
someone will test it and provide some feedback/comments. This is by no
means ready for general
use so don't use for anything else than experimentation. But since
this script only opens mailboxes
in read only mode (examine) there should not be any problems with you
emails on the server.

This script is GMail specific and has these features:

  - Downloads emails from all mailboxes (except All, Trash and Spam)
automatically using
    the XLIST GMail IMAP extension and feeds them to Heliotrope via
REST interface.
  - Remembers the last email downloaded so it does not start from the beginning
    every time.
  - Synchronizes GMail labels using the X-GM-LABELS IMAP extension.
  - Synchronizes GMail flags with Heliotrope state flags.
  - Adds a new mailbox property to messages. This may allow later to implement
    Heliotrope -&gt; GMail synchronization.

Things to check and do:
  - I am seeing some negative thread_id's in the response. Need to check if
    this is normal or a bug in Heliotrope or my script.
  - GMail inbox is with a capital &quot;I&quot; (e.g. Inbox) while heliotrope
uses a small &quot;i&quot;.
    Shall I down case all labels? or make a special treatment for Inbox?
  - Refactor the script into something more modular and elegant.

To use this script I had to modify heliotrope-server.rb to allow
setting labels and states when
posting new messages (see attached patch).

regards,
Horacio

On Tue, May 17, 2011 at 12:02 AM, Horacio Sanson &lt;hsanson@gmail.com&gt; wrote:
&gt; On Mon, May 16, 2011 at 12:01 AM, William Morgan
&gt; &lt;wmorgan-sup@masanjin.net&gt; wrote:
&gt;&gt; Reformatted excerpts from Horacio Sanson's message of 2011-05-10:
&gt;&gt;&gt; Is there a way to query Heliotrope what is the largest msg_id
&gt;&gt;&gt; currently in the index?
&gt;&gt;
&gt;&gt; Sort of---it's a hack, but if you search for e.g. &quot;a OR -a&quot; you'll get
&gt;&gt; every message in the index, and the first result will be the message
&gt;&gt; with the highest id thanks to Whistlepig's search semantics.
&gt;&gt;
&gt;
&gt; Indeed I have been trying to wrap my head around the IMAP spec and
&gt; still don't get a lot of things. For now I will just keep the max UID
&gt; read from IMAP server somewhere on disk.
&gt;
&gt;&gt;&gt; I am trying to improve the imap-dumper.rb so
&gt;&gt;&gt; it does not download all my emails every time but only the new ones.
&gt;&gt;
&gt;&gt; Sounds great. Unfortunately the Heliotrope message id and the IMAP
&gt;&gt; message id / message uid are completely different things, and
&gt;&gt; maintaining a cross-session mapping of them is impossible for generic
&gt;&gt; IMAP servers, because the uid of every message can change every time you
&gt;&gt; connect to an IMAP server---see the section on IMAP's 'uidvalidity'
&gt;&gt; variable. So you'll have to rescan the inbox every time and rebuild the
&gt;&gt; mapping. Welcome to hell.
&gt;&gt;
&gt;
&gt; When UIDVALIDITY differs I will simply re-scan the whole mailbox and
&gt; feed it to Heliotrope. I trust Heliotrope won't add duplicates.
&gt;
&gt;&gt;&gt; Also while looking at the code I see that messages are stored in the
&gt;&gt;&gt; index using the msg_id as parsed by RMail. There is no further
&gt;&gt;&gt; association with the source or mailbox from where the messages were
&gt;&gt;&gt; downloaded. This I think may cause collisions if we use one Heliotrope
&gt;&gt;&gt; server with more than one email account. Not sure what is the
&gt;&gt;&gt; probability of two messages from two different IMAP servers having the
&gt;&gt;&gt; same msg_id but nothing in the standard rules out that possibility.
&gt;&gt;
&gt;&gt; This is yet another id: the Message-Id header of the email. This is only
&gt;&gt; needed to build up the thread structure and should otherwise be ignored.
&gt;
&gt; I am attaching my first small hack for GMail &lt;-&gt; Heliotrope
&gt; synchronization. For now it only downloads mail from GMail and injects
&gt; them to Heliotrope just as the imap-dumper.rb does. The difference is
&gt; that I keep track of the last message UID and UIDVALIDITY values to
&gt; avoid re-scanning the whole folder every time.
&gt;
&gt; Now I wan't to take advantage of GMail IMAP extensions (e.g.
&gt; X-GM-LABELS, X-GM-THRID) to allow labels/threads synchronization. But
&gt; have some doubts about how to correctly use the Heliotrope REST API.
&gt; For example in the Heliotrope::Index the add_message method allows to
&gt; insert a message and assign it labels, flags and extra parameters at
&gt; the same time. How can I do this with the REST API? The only example I
&gt; see only adds a message body.
&gt;
&gt; &#xA0; &#xA0;RestClient.post &quot;<a  rel="nofollow" href="http://localhost:8042/message&quot">http://localhost:8042/message&quot</a>;, :message =&gt; body
&gt;
&gt; Also for what purpose are the ext array used for? Can I use it to add
&gt; an account/mailbox property to each message so I can latter retrieve
&gt; all messages associated to a mailbox/account pair?
&gt;
&gt; regards,
&gt; Horacio
&gt;
&gt;&gt; --
&gt;&gt; William &lt;wmorgan-sup@masanjin.net&gt;
&gt;&gt; _______________________________________________
&gt;&gt; Sup-devel mailing list
&gt;&gt; Sup-devel@rubyforge.org
&gt;&gt; <a  rel="nofollow" href="http://rubyforge.org/mailman/listinfo/sup-devel">http://rubyforge.org/mailman/listinfo/sup-devel</a>
&gt;&gt;
&gt;
</pre><p><strong>Attachment:
<a href="bin3fwdvsGE6s.bin" ><tt>gmail.rb</tt></a></strong><br>
<em>Description:</em> application/ruby</p>
<pre>From 5504d5732ebe3c8b86b942b9b898221a520d283f Mon Sep 17 00:00:00 2001
From: Horacio Sanson &lt;hsanson@gmail.com&gt;
Date: Tue, 17 May 2011 23:34:14 +0900
Subject: [PATCH] Implement post /message.json.

Now we can  add messages to heliotrope with labels, state and mailbox
information in a single POST request. The request body has to be JSON
with a format like:

{
  body: &lt;rfc822 raw message string&gt;,
  labels: [&quot;inbox&quot;, &quot;school&quot;, &quot;home&quot;],
  state: [&quot;seen&quot;, &quot;old&quot;],
  mailbox: &quot;inbox&quot;
}
---
 bin/heliotrope-server |   30 +++++++++++++++++++++++++++---
 1 files changed, 27 insertions(+), 3 deletions(-)

diff --git a/bin/heliotrope-server b/bin/heliotrope-server
index d71989d..93b0490 100644
--- a/bin/heliotrope-server
+++ b/bin/heliotrope-server
@@ -302,10 +302,34 @@ class HeliotropeServer &lt; Sinatra::Base
   end
 
   post &quot;/message.json&quot; do
-    body = params[&quot;body&quot;] or raise RequestError, &quot;need a 'body' param&quot;
-    puts body
+    content_type :json
+    begin
+      rawbody = params[&quot;body&quot;] or raise RequestError, &quot;need a 'body' param&quot;
+      rawbody.force_encoding &quot;binary&quot; if rawbody.respond_to?(:force_encoding) # sigh...
 
-    {:status =&gt; &quot;ok&quot;}.to_json
+      message = Heliotrope::Message.new(rawbody).parse!
+
+      mbox = params[&quot;mailbox&quot;] || &quot;inbox&quot;
+      doc_id = nil
+      thread_id = nil
+      state = nil
+      labels = [mbox]
+      if @index.contains_msgid? message.msgid
+        messageinfo = get_message_summary message.msgid
+        doc_id =  messageinfo[:message_id]
+        thread_id = messageinfo[:thread_id]
+        { :response =&gt; :ok, :status =&gt; :seen, :doc_id =&gt; doc_id, :thread_id =&gt; thread_id }
+      else
+        # Set state
+        state params[&quot;state&quot;] || [&quot;unseen&quot;]
+        labels.push(params[&quot;labels&quot;]).flatten!.uniq! if params[&quot;labels&quot;]
+        loc = @store.add rawbody
+        doc_id, thread_id = @index.add_message message, state, labels, { :loc =&gt; loc, :mbox =&gt; mbox }
+        { :response =&gt; :ok, :status =&gt; state, :doc_id =&gt; doc_id, :thread_id =&gt; thread_id, :labels =&gt; labels }
+      end
+    rescue Heliotrope::InvalidMessageError =&gt; e
+      { :response =&gt; :error, :error_message =&gt; e.message }
+    end.to_json
   end
 
 private
-- 
1.7.4.1

</pre><pre>_______________________________________________
Sup-devel mailing list
Sup-devel@rubyforge.org
<a  rel="nofollow" href="http://rubyforge.org/mailman/listinfo/sup-devel">http://rubyforge.org/mailman/listinfo/sup-devel</a>
</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00044" href="msg00044.html">Re: [sup-devel] Query for largest msg_id?</a></strong>
<ul><li><em>From:</em> Horacio Sanson &lt;hsanson@gmail.com&gt;</li></ul></li>
<li><strong><a name="00373" href="msg00373.html">Re: [sup-devel] Query for largest msg_id?</a></strong>
<ul><li><em>From:</em> William Morgan &lt;wmorgan-sup@masanjin.net&gt;</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00502" href="msg00502.html">[sup-devel] Query for largest msg_id?</a></strong>
<ul><li><em>From:</em> Horacio Sanson &lt;hsanson@gmail.com&gt;</li></ul></li>
<li><strong><a name="00313" href="msg00313.html">Re: [sup-devel] Query for largest msg_id?</a></strong>
<ul><li><em>From:</em> William Morgan &lt;wmorgan-sup@masanjin.net&gt;</li></ul></li>
<li><strong><a name="00126" href="msg00126.html">Re: [sup-devel] Query for largest msg_id?</a></strong>
<ul><li><em>From:</em> Horacio Sanson &lt;hsanson@gmail.com&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00044.html">Re: [sup-devel] Query for largest msg_id?</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00308.html">Re: [sup-devel] Query for largest msg_id?</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00126.html">Re: [sup-devel] Query for largest msg_id?</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00044.html">Re: [sup-devel] Query for largest msg_id?</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#00199"><strong>Date</strong></a></li>
<li><a href="threads.html#00199"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</body>
</html>
