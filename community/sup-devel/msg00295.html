<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: [sup&#45;devel] Heliotrope improving but still found some issues -->
<!--X-From-R13: Vbenpvb Enafba <ufnafbaNtznvy.pbz> -->
<!--X-Date: Tue, 5 Jul 2011 07:04:27 &#45;0700 (PDT) -->
<!--X-Message-Id: CAHWBo_ZuLKhx&#45;MW4O=1Nwi3A3KkSfyDQUpmnbmvHL62d9P1XuQ@mail.gmail.com -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Reference: 201107051052.53166.hsanson@gmail.com -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: [sup-devel] Heliotrope improving but still found some issues</title>
<link rev="made" href="mailto:hsanson@gmail.com">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<a href="msg00343.html">Date Prev</a>][<a href="msg00069.html">Date Next</a>][<a href="msg00375.html">Thread Prev</a>][<a href="msg00369.html">Thread Next</a>][<a href="maillist.html#00295">Date Index</a>][<a href="threads.html#00295">Thread Index</a>]
<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [sup-devel] Heliotrope improving but still found some issues</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: <a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a></li>
<li><em>Subject</em>: Re: [sup-devel] Heliotrope improving but still found some issues</li>
<li><em>From</em>: Horacio Sanson &lt;<a href="mailto:hsanson%40gmail.com">hsanson@gmail.com</a>&gt;</li>
<li><em>Date</em>: Tue, 5 Jul 2011 23:01:19 +0900</li>
<li><em>Authentication-results</em>: mx.google.com; spf=pass (google.com: domain of <a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a> designates 205.234.109.19 as permitted sender) smtp.mail=<a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a>; dkim=neutral (body hash did not verify) header.i=@gmail.com</li>
<li><em>Delivered-to</em>: <a href="mailto:eg%40gaute.vetsj.com">eg@gaute.vetsj.com</a></li>
<li><em>Delivered-to</em>: <a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a></li>
<li><em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=gamma;	h=mime-version:in-reply-to:references:date:message-id:subject:from:to	:content-type; bh=pSIjTStcG7zREzUa5NE1g5OXKdIhgDWjcsrK1p11CxM=;	b=BelUdQ+YT6YMT5HNCC4ttv+ipE5psAMmijis4LOZu99cFv33ErsxnmZQCkkOZj5BWG	aH7yG2+urElBQeohUMCV5p+eN13J6jPtK+GfRHfHO3XDNrCam69LkeLSaOnEiZOLXg57	KUvW+szAoFWKNY+ScXQjYmlIx3Dq+jNOY+PH4=</li>
<li><em>In-reply-to</em>: &lt;<a href="msg00375.html">201107051052.53166.hsanson@gmail.com</a>&gt;</li>
<li><em>List-archive</em>: &lt;<a href="http://rubyforge.org/pipermail/sup-devel">http://rubyforge.org/pipermail/sup-devel</a>&gt;</li>
<li><em>List-help</em>: &lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=help">mailto:sup-devel-request@rubyforge.org?subject=help</a>&gt;</li>
<li><em>List-id</em>: Sup developer discussion &lt;sup-devel.rubyforge.org&gt;</li>
<li><em>List-post</em>: &lt;<a href="mailto:sup-devel@rubyforge.org">mailto:sup-devel@rubyforge.org</a>&gt;</li>
<li><em>List-subscribe</em>: &lt;<a href="http://rubyforge.org/mailman/listinfo/sup-devel">http://rubyforge.org/mailman/listinfo/sup-devel</a>&gt;,	&lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=subscribe">mailto:sup-devel-request@rubyforge.org?subject=subscribe</a>&gt;</li>
<li><em>List-unsubscribe</em>: &lt;<a href="http://rubyforge.org/mailman/options/sup-devel">http://rubyforge.org/mailman/options/sup-devel</a>&gt;,	&lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=unsubscribe">mailto:sup-devel-request@rubyforge.org?subject=unsubscribe</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg00375.html">201107051052.53166.hsanson@gmail.com</a>&gt;</li>
<li><em>Reply-to</em>: Sup developer discussion &lt;<a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a>&gt;</li>
<li><em>Sender</em>: <a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a></li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Speaked too fast...  got a few more issues.

First the patch I sent was incomplete, please ignore and use the one
attached here if you would. The previous patch completely removed the
header section of the web page.

Second the GMail labels work great as long as they are in english.
This is because the labels are UTF-7 encoded and look like this in
japanese: &quot;+&amp;mlkwrtdrmkiwwzdxmlgw4zdrmpm-&quot; and clicking on any of
these labels in the web interface result in systax error. Fixing this
is as simple as replacing line 207 of imap-dumper.rb with the
following code:

labels = (data.attr[&quot;X-GM-LABELS&quot;] || []).map { |label|
Net::IMAP.decode_utf7(label.to_s).downcase }

I am pretty sure the utf7 decoding is language independent and can be
applied safely to all labels in any language but I cannot bet on it
since I only have tested Japanese. Not sure if this conversion would
require a separate hook or something like that.



regards,
Horacio

On Tue, Jul 5, 2011 at 10:52 AM, Horacio Sanson &lt;hsanson@gmail.com&gt; wrote:
&gt;
&gt; So I tried the latest heliotrope with the leveldb-ruby 0.6 gem, whistlepig 0.7
&gt; and MeCab hooks for Japanese text support and it works better than before.
&gt; Unfortunately got two issues:
&gt;
&gt; First any attempt to search using japanese text fails with the dreaded
&gt; incompatible character encodings error:
&gt;
&gt; #####################################################
&gt; [2011-07-05 10:22:17] INFO &#xA0;WEBrick 1.3.1
&gt; [2011-07-05 10:22:17] INFO &#xA0;ruby 1.9.2 (2010-08-18) [x86_64-linux]
&gt; [2011-07-05 10:22:17] INFO &#xA0;WEBrick::HTTPServer#start: pid=13523 port=8042
&gt; search(body:&quot;&#x624B;&#x7D19;&quot;, 0, 20) took 2.1ms
&gt; Encoding::CompatibilityError - incompatible character encodings: ASCII-8BIT
&gt; and UTF-8:
&gt; &#xA0;bin/heliotrope-server:223:in `block in &lt;class:HeliotropeServer&gt;'
&gt; &#xA0;/var/lib/gems/1.9.1/gems/sinatra-1.2.5/lib/sinatra/base.rb:1152:in `call'
&gt; &#xA0;/var/lib/gems/1.9.1/gems/sinatra-1.2.5/lib/sinatra/base.rb:1152:in `block in
&gt; compile!'
&gt; &#xA0;/var/lib/gems/1.9.1/gems/sinatra-1.2.5/lib/sinatra/base.rb:724:in
&gt; `instance_eval'
&gt; &#xA0;/var/lib/gems/1.9.1/gems/sinatra-1.2.5/lib/sinatra/base.rb:724:in
&gt; `route_eval'
&gt; &#xA0;/var/lib/gems/1.9.1/gems/sinatra-1.2.5/lib/sinatra/base.rb:708:in `block (2
&gt; levels) in route!'
&gt; &#xA0;/var/lib/gems/1.9.1/gems/sinatra-1.2.5/lib/sinatra/base.rb:758:in `block in
&gt; process_route'
&gt; &#xA0;/var/lib/gems/1.9.1/gems/sinatra-1.2.5/lib/sinatra/base.rb:755:in `catch'
&gt; &#xA0;/var/lib/gems/1.9.1/gems/sinatra-1.2.5/lib/sinatra/base.rb:755:in
&gt; `process_route'
&gt; &#xA0;/var/lib/gems/1.9.1/gems/sinatra-1.2.5/lib/sinatra/base.rb:707:in `block in
&gt; route!'
&gt; &#xA0;/var/lib/gems/1.9.1/gems/sinatra-1.2.5/lib/sinatra/base.rb:706:in `each'
&gt; &#xA0;/var/lib/gems/1.9.1/gems/sinatra-1.2.5/lib/sinatra/base.rb:706:in `route!'
&gt; &#xA0;/var/lib/gems/1.9.1/gems/sinatra-1.2.5/lib/sinatra/base.rb:843:in `dispatch!'
&gt; &#xA0;/var/lib/gems/1.9.1/gems/sinatra-1.2.5/lib/sinatra/base.rb:644:in `block in
&gt; call!'
&gt; &#xA0;/var/lib/gems/1.9.1/gems/sinatra-1.2.5/lib/sinatra/base.rb:808:in
&gt; `instance_eval'
&gt; &#xA0;/var/lib/gems/1.9.1/gems/sinatra-1.2.5/lib/sinatra/base.rb:808:in `block in
&gt; invoke'
&gt; &#xA0;/var/lib/gems/1.9.1/gems/sinatra-1.2.5/lib/sinatra/base.rb:808:in `catch'
&gt; &#xA0;/var/lib/gems/1.9.1/gems/sinatra-1.2.5/lib/sinatra/base.rb:808:in `invoke'
&gt; &#xA0;/var/lib/gems/1.9.1/gems/sinatra-1.2.5/lib/sinatra/base.rb:644:in `call!'
&gt; &#xA0;/var/lib/gems/1.9.1/gems/sinatra-1.2.5/lib/sinatra/base.rb:629:in `call'
&gt; &#xA0;/var/lib/gems/1.9.1/gems/rack-1.2.2/lib/rack/head.rb:9:in `call'
&gt; &#xA0;/var/lib/gems/1.9.1/gems/sinatra-1.2.5/lib/sinatra/showexceptions.rb:21:in
&gt; `call'
&gt; &#xA0;/var/lib/gems/1.9.1/gems/rack-1.2.2/lib/rack/lint.rb:48:in `_call'
&gt; &#xA0;/var/lib/gems/1.9.1/gems/rack-1.2.2/lib/rack/lint.rb:36:in `call'
&gt; &#xA0;/var/lib/gems/1.9.1/gems/rack-1.2.2/lib/rack/showexceptions.rb:24:in `call'
&gt; &#xA0;/var/lib/gems/1.9.1/gems/rack-1.2.2/lib/rack/commonlogger.rb:18:in `call'
&gt; &#xA0;/var/lib/gems/1.9.1/gems/rack-1.2.2/lib/rack/content_length.rb:13:in `call'
&gt; &#xA0;/var/lib/gems/1.9.1/gems/rack-1.2.2/lib/rack/handler/webrick.rb:52:in
&gt; `service'
&gt; &#xA0;/usr/lib/ruby/1.9.1/webrick/httpserver.rb:111:in `service'
&gt; &#xA0;/usr/lib/ruby/1.9.1/webrick/httpserver.rb:70:in `run'
&gt; &#xA0;/usr/lib/ruby/1.9.1/webrick/server.rb:183:in `block in start_thread'
&gt; 127.0.0.1 - - [05/Jul/2011 10:22:20] &quot;GET /search?q=%E6%89%8B%E7%B4%99
&gt; HTTP/1.1&quot; 500 89118 0.0331
&gt; localhost - - [05/Jul/2011:10:22:20 JST] &quot;GET /search?q=%E6%89%8B%E7%B4%99
&gt; HTTP/1.0&quot; 500 89118
&gt; - -&gt; /search?q=%E6%89%8B%E7%B4%99
&gt; [2011-07-05 10:22:20] ERROR Errno::ECONNRESET: Connection reset by peer
&gt; &#xA0; &#xA0; &#xA0; &#xA0;/usr/lib/ruby/1.9.1/webrick/httpserver.rb:56:in `eof?'
&gt; &#xA0; &#xA0; &#xA0; &#xA0;/usr/lib/ruby/1.9.1/webrick/httpserver.rb:56:in `run'
&gt; #######################################################
&gt;
&gt; The problem seems to be the header method in the heliotrope-server that uses
&gt; multiline strings (e.g. &lt;&lt;- EOS). By forcing the resulting text to UTF-8
&gt; encoding the search works as expected with japanese and non japanese text (see
&gt; attached patch).
&gt;
&gt;
&gt; The second problem is actually not heliotrope problem. Is the artificial
&gt; limitations imposed by Gmail. After running heliotrope-add for some time it
&gt; would fail when the IMAP fetch returns nil. Just after it failed I tried to
&gt; use my current email reader (kmail) and got an interesting error saying:
&gt; &quot;exceeded IMAP bandwidth limits&quot;. These indicates the nil is due to Gmail
&gt; limiting the maximum bandwidth I can consume downloading emails.
&gt;
&gt; The latest heliotrope now catches this error and ignores it but after a while
&gt; ignoring it I started getting sys-write errors on the socket. I believe this
&gt; is also GMail abruptly breaking the socket connection to enforce it's
&gt; bandwidth limits.
&gt;
&gt; Maybe limiting the rate of gmail-dumper so it reads mails at a lower pace
&gt; would eliminate these problems or simply stop reading emails for some time
&gt; when we get the first nil response.
&gt;
&gt; Overall heliotrope is now usable for Japanese language users (at least for me
&gt; ). Now I will start playing with turnsole to see if it can handle japanese.
&gt;
&gt; --
&gt; regards,
&gt; Horacio Sanson
&gt;
</pre><pre>From 90ef5390daf4fa7a05d62c3a61a1eee9b7e8061a Mon Sep 17 00:00:00 2001
From: Horacio Sanson &lt;hsanson@gmail.com&gt;
Date: Tue, 5 Jul 2011 10:31:33 +0900
Subject: [PATCH] Fix encoding exception.

---
 bin/heliotrope-server |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/bin/heliotrope-server b/bin/heliotrope-server
index 15dc897..26ae4c5 100644
--- a/bin/heliotrope-server
+++ b/bin/heliotrope-server
@@ -530,7 +530,7 @@ private
 
   def header title, query=&quot;&quot;
     title = escape_html title
-    &lt;&lt;-EOS
+    title = &lt;&lt;-EOS
 &lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot;&gt;&lt;title&gt;Heliotrope: #{title}&lt;/title&gt;
 &lt;meta name=&quot;application-name&quot; content=&quot;heliotrope&quot;&gt;
 &lt;style type=&quot;text/css&quot;&gt;
@@ -557,6 +557,9 @@ td {
   &lt;input type=&quot;submit&quot; value=&quot;go&quot;/&gt;
   &lt;/form&gt;&lt;/div&gt;
     EOS
+
+    title.force_encoding(Encoding::UTF_8) if title.respond_to?(:force_encoding) # sigh...
+    title
   end
 
   def footer
-- 
1.7.4.1

</pre><pre>_______________________________________________
Sup-devel mailing list
Sup-devel@rubyforge.org
<a  rel="nofollow" href="http://rubyforge.org/mailman/listinfo/sup-devel">http://rubyforge.org/mailman/listinfo/sup-devel</a>
</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00369" href="msg00369.html">Re: [sup-devel] Heliotrope improving but still found some issues</a></strong>
<ul><li><em>From:</em> William Morgan &lt;wmorgan-sup@masanjin.net&gt;</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00375" href="msg00375.html">[sup-devel] Heliotrope improving but still found some issues</a></strong>
<ul><li><em>From:</em> Horacio Sanson &lt;hsanson@gmail.com&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00343.html">Re: [sup-devel] gmail limits [was: Heliotrope improving but still found some issues]</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00069.html">[sup-devel] How are the queries supposed to work?</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00375.html">[sup-devel] Heliotrope improving but still found some issues</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00369.html">Re: [sup-devel] Heliotrope improving but still found some issues</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#00295"><strong>Date</strong></a></li>
<li><a href="threads.html#00295"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</body>
</html>
