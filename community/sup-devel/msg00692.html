<!-- MHonArc v2.6.18 -->
<!--X-Subject: [sup&#45;devel] [PATCH] Adding a gpgkey option -->
<!--X-From-R13: Vnzvfu R <qzvfuqNtznvy.pbz> -->
<!--X-Date: Sun, 10 Oct 2010 09:29:25 &#45;0700 (PDT) -->
<!--X-Message-Id: AANLkTi=dw_GeGVV90HyBXozTsb9BKL4YB4gCUH_pbtVs@mail.gmail.com -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>[sup-devel] [PATCH] Adding a gpgkey option</title>
<link rev="made" href="mailto:dmishd@gmail.com">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<a href="msg00618.html">Date Prev</a>][<a href="msg00607.html">Date Next</a>][<a href="msg00630.html">Thread Prev</a>][<a href="msg00514.html">Thread Next</a>][<a href="maillist.html#00692">Date Index</a>][<a href="threads.html#00692">Thread Index</a>]
<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>[sup-devel] [PATCH] Adding a gpgkey option</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: <a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a></li>
<li><em>Subject</em>: [sup-devel] [PATCH] Adding a gpgkey option</li>
<li><em>From</em>: Hamish D &lt;<a href="mailto:dmishd%40gmail.com">dmishd@gmail.com</a>&gt;</li>
<li><em>Date</em>: Sun, 10 Oct 2010 17:25:18 +0100</li>
<li><em>Authentication-results</em>: mx.google.com; spf=pass (google.com: domain of <a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a> designates 205.234.109.19 as permitted sender) smtp.mail=<a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a>; dkim=neutral (body hash did not verify) header.i=@gmail.com</li>
<li><em>Cc</em>: <a href="mailto:micah%40riseup.net">micah@riseup.net</a></li>
<li><em>Delivered-to</em>: <a href="mailto:eg%40gaute.vetsj.com">eg@gaute.vetsj.com</a></li>
<li><em>Delivered-to</em>: <a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a></li>
<li><em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=gamma;	h=domainkey-signature:mime-version:received:received:date:message-id	:subject:from:to:cc:content-type;	bh=kT7X7YCCL9UWe5jFo/XkHwOe8LaG1Yxu3jHaaCJbQMU=;	b=wp/v0JKosHxrLdDIYi1gi9qmVMvDEGl+zBNIpScJi8Q3EvGMPxi44moxFV12AcEjOj	D/+NyEOP2siNz5ylpS4Sg5FrijVXew7ccmqAYo65090CdNFC0C7WbwQIK+HQyYE/T70P	Q078J9PHDEvpJ5pY7hYZQMOYaiBkCqwXCBWdk=</li>
<li><em>Domainkey-signature</em>: a=rsa-sha1; c=nofws; d=gmail.com; s=gamma;	h=mime-version:date:message-id:subject:from:to:cc:content-type;	b=tvGB2rfYMKVKw5sWkjKHoLfH+t319ovXTXvAZJkKO0r4QCC7oPBa9fG+JKXfsh1VQb	1XHbiiN3WwwllVSZX5aolcGo/I45o9hsmf/r+NiqE/k1fqXJRsI9IL0kIDt/oohxydGR	HP8nYfgvlPqHYaUVEzbvauOmvAHAOtYuz8apc=</li>
<li><em>List-archive</em>: &lt;<a href="http://rubyforge.org/pipermail/sup-devel">http://rubyforge.org/pipermail/sup-devel</a>&gt;</li>
<li><em>List-help</em>: &lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=help">mailto:sup-devel-request@rubyforge.org?subject=help</a>&gt;</li>
<li><em>List-id</em>: Sup developer discussion &lt;sup-devel.rubyforge.org&gt;</li>
<li><em>List-post</em>: &lt;<a href="mailto:sup-devel@rubyforge.org">mailto:sup-devel@rubyforge.org</a>&gt;</li>
<li><em>List-subscribe</em>: &lt;<a href="http://rubyforge.org/mailman/listinfo/sup-devel">http://rubyforge.org/mailman/listinfo/sup-devel</a>&gt;,	&lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=subscribe">mailto:sup-devel-request@rubyforge.org?subject=subscribe</a>&gt;</li>
<li><em>List-unsubscribe</em>: &lt;<a href="http://rubyforge.org/mailman/options/sup-devel">http://rubyforge.org/mailman/options/sup-devel</a>&gt;,	&lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=unsubscribe">mailto:sup-devel-request@rubyforge.org?subject=unsubscribe</a>&gt;</li>
<li><em>Reply-to</em>: Sup developer discussion &lt;<a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a>&gt;</li>
<li><em>Sender</em>: <a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a></li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>&gt;From the commit message:

    Added a gpgkey option to the account settings

    This allows the user to specify the gpg key used. In addition, if
    gpgkey is not set, and there is only one email address defined, then
    sup will not pass any id to gpg, so gpg will use its default key.
    Only if gpgkey is not set and there are multiple email addresses
    will sup use the old behaviour of defining the key to use by
    passing gpg the from email address.

This has been requested before:
<a  rel="nofollow" href="http://rubyforge.org/pipermail/sup-devel/2009-November/000029.html">http://rubyforge.org/pipermail/sup-devel/2009-November/000029.html</a>

I've given it some basic testing (using the gpg-args hook to view the
arguments) and it appears to work as I intend it to in all 3 cases I
mention in the comment. I'm not a massively experienced ruby hacker,
so any feedback or improvements appreciated.

Hamish
</pre><pre>From 6b3d7101756e703a52ec7e2a8606b6ee583895c9 Mon Sep 17 00:00:00 2001
From: Hamish Downer &lt;dmishd@gmail.com&gt;
Date: Sun, 10 Oct 2010 17:18:41 +0100
Subject: [PATCH] Added a gpgkey option to the account settings

This allows the user to specify the gpg key used. In addition, if
gpgkey is not set, and there is only one email address defined, then
sup will not pass any id to gpg, so gpg will use its default key.
Only if gpgkey is not set and there are multiple email addresses
will sup use the old behaviour of defining the key to use by
passing gpg the from email address.
---
 lib/sup.rb         |    3 ++-
 lib/sup/account.rb |    5 +++--
 lib/sup/crypto.rb  |   23 +++++++++++++++++++++--
 3 files changed, 26 insertions(+), 5 deletions(-)

diff --git a/lib/sup.rb b/lib/sup.rb
index abd3bce..0e051be 100644
--- a/lib/sup.rb
+++ b/lib/sup.rb
@@ -261,7 +261,8 @@ EOS
             :email =&gt; email,
             :alternates =&gt; [],
             :sendmail =&gt; &quot;/usr/sbin/sendmail -oem -ti&quot;,
-            :signature =&gt; File.join(ENV[&quot;HOME&quot;], &quot;.signature&quot;)
+            :signature =&gt; File.join(ENV[&quot;HOME&quot;], &quot;.signature&quot;),
+            :gpgkey =&gt; &quot;&quot;
           }
         },
         :editor =&gt; ENV[&quot;EDITOR&quot;] || &quot;/usr/bin/vim -f -c 'setlocal spell spelllang=en_us' -c 'set filetype=mail'&quot;,
diff --git a/lib/sup/account.rb b/lib/sup/account.rb
index f932f4c..1718d94 100644
--- a/lib/sup/account.rb
+++ b/lib/sup/account.rb
@@ -1,7 +1,7 @@
 module Redwood
 
 class Account &lt; Person
-  attr_accessor :sendmail, :signature
+  attr_accessor :sendmail, :signature, :gpgkey
 
   def initialize h
     raise ArgumentError, &quot;no name for account&quot; unless h[:name]
@@ -9,6 +9,7 @@ class Account &lt; Person
     super h[:name], h[:email]
     @sendmail = h[:sendmail]
     @signature = h[:signature]
+    @gpgkey = h[:gpgkey]
   end
 
   # Default sendmail command for bouncing mail,
@@ -46,7 +47,7 @@ class AccountManager
   def add_account hash, default=false
     raise ArgumentError, &quot;no email specified for account&quot; unless hash[:email]
     unless default
-      [:name, :sendmail, :signature].each { |k| hash[k] ||= @default_account.send(k) }
+      [:name, :sendmail, :signature, :gpgkey].each { |k| hash[k] ||= @default_account.send(k) }
     end
     hash[:alternates] ||= []
 
diff --git a/lib/sup/crypto.rb b/lib/sup/crypto.rb
index 2bd5350..19983d2 100644
--- a/lib/sup/crypto.rb
+++ b/lib/sup/crypto.rb
@@ -45,7 +45,8 @@ EOS
 
     sig_fn = Tempfile.new &quot;redwood.signature&quot;; sig_fn.close
 
-    message = run_gpg &quot;--output #{sig_fn.path} --yes --armor --detach-sign --textmode --digest-algo sha256 --local-user '#{from}' #{payload_fn.path}&quot;, :interactive =&gt; true
+    sign_user_opts = gen_sign_user_opts from
+    message = run_gpg &quot;--output #{sig_fn.path} --yes --armor --detach-sign --textmode --digest-algo sha256 #{sign_user_opts} #{payload_fn.path}&quot;, :interactive =&gt; true
     unless $?.success?
       info &quot;Error while running gpg: #{message}&quot;
       raise Error, &quot;GPG command failed. See log for details.&quot;
@@ -68,7 +69,8 @@ EOS
     encrypted_fn = Tempfile.new &quot;redwood.encrypted&quot;; encrypted_fn.close
 
     recipient_opts = (to + [ from ] ).map { |r| &quot;--recipient '&lt;#{r}&gt;'&quot; }.join(&quot; &quot;)
-    sign_opts = sign ? &quot;--sign --local-user '#{from}'&quot; : &quot;&quot;
+    sign_opts = &quot;&quot;
+    sign_opts = &quot;--sign --digest-algo sha256 &quot; + gen_sign_user_opts(from) if sign
     message = run_gpg &quot;--output #{encrypted_fn.path} --yes --armor --encrypt --textmode #{sign_opts} #{recipient_opts} #{payload_fn.path}&quot;, :interactive =&gt; true
     unless $?.success?
       info &quot;Error while running gpg: #{message}&quot;
@@ -208,6 +210,23 @@ private
     payload.to_s.gsub(/(^|[^\r])\n/, &quot;\\1\r\n&quot;).gsub(/^MIME-Version: .*\r\n/, &quot;&quot;)
   end
 
+  # logic is:
+  # if    gpgkey set for this account, then use that
+  # elsif only one account,            then leave blank so gpg default will be user
+  # else                                    set --local-user from_email_address
+  def gen_sign_user_opts from
+    account = AccountManager.account_for from
+    if !account.gpgkey.nil?
+      opts = &quot;--local-user '#{account.gpgkey}'&quot;
+    elsif AccountManager.user_emails.length == 1
+      # only one account
+      opts = &quot;&quot;
+    else
+      opts = &quot;--local-user '#{from}'&quot; 
+    end
+    opts
+  end
+
   def run_gpg args, opts={}
     args = HookManager.run(&quot;gpg-args&quot;, { :args =&gt; args }) || args
     cmd = &quot;LC_MESSAGES=C #{@cmd} #{args}&quot;
-- 
1.7.1

</pre><pre>_______________________________________________
Sup-devel mailing list
Sup-devel@rubyforge.org
<a  rel="nofollow" href="http://rubyforge.org/mailman/listinfo/sup-devel">http://rubyforge.org/mailman/listinfo/sup-devel</a>
</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00514" href="msg00514.html">Re: [sup-devel] [PATCH] Adding a gpgkey option</a></strong>
<ul><li><em>From:</em> Rich Lane &lt;rlane@club.cc.cmu.edu&gt;</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00618.html">Re: [sup-devel] [PATCH] s/@filename/@path/ in MBox#store_message</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00607.html">[sup-devel] [PATCH] Bugfix: fix regexp for detecting filename in	Content-Disposition header</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00630.html">Re: [sup-devel] [PATCH] [mq]: mbox-path-fix</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00514.html">Re: [sup-devel] [PATCH] Adding a gpgkey option</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#00692"><strong>Date</strong></a></li>
<li><a href="threads.html#00692"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</body>
</html>
