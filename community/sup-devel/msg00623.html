<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: [sup&#45;devel] Cannot query Japanese characters -->
<!--X-From-R13: Vbenpvb Enafba <ufnafbaNtznvy.pbz> -->
<!--X-Date: Tue, 3 May 2011 22:06:19 &#45;0700 (PDT) -->
<!--X-Message-Id: BANLkTikbENFqT2GsE5uWjqN_DTMq43FFkw@mail.gmail.com -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Reference: 201104251023.19659.hsanson@gmail.com -->
<!--X-Reference: 1303793294&#45;sup&#45;688@masanjin.net -->
<!--X-Reference: 1304052708&#45;sup&#45;4240@masanjin.net -->
<!--X-Reference: BANLkTim9PigP91LaDQ6UG2_prxncYv1zEA@mail.gmail.com -->
<!--X-Reference: BANLkTi=ObuZiHWGs7Mtvh8J5k4J3KTxgMA@mail.gmail.com -->
<!--X-Reference: BANLkTi=tSnbEijoEHG76Z5Fy9&#45;3G4TPxVw@mail.gmail.com -->
<!--X-Reference: 1304460745&#45;sup&#45;6241@masanjin.net -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: [sup-devel] Cannot query Japanese characters</title>
<link rev="made" href="mailto:hsanson@gmail.com">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<a href="msg00508.html">Date Prev</a>][<a href="msg00573.html">Date Next</a>][<a href="msg00611.html">Thread Prev</a>][<a href="msg00508.html">Thread Next</a>][<a href="maillist.html#00623">Date Index</a>][<a href="threads.html#00623">Thread Index</a>]
<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [sup-devel] Cannot query Japanese characters</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: Sup developer discussion &lt;<a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a>&gt;</li>
<li><em>Subject</em>: Re: [sup-devel] Cannot query Japanese characters</li>
<li><em>From</em>: Horacio Sanson &lt;<a href="mailto:hsanson%40gmail.com">hsanson@gmail.com</a>&gt;</li>
<li><em>Date</em>: Wed, 4 May 2011 10:42:25 +0900</li>
<li><em>Authentication-results</em>: mx.google.com; spf=pass (google.com: domain of <a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a> designates 205.234.109.19 as permitted sender) smtp.mail=<a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a>; dkim=neutral (body hash did not verify) header.i=@gmail.com</li>
<li><em>Delivered-to</em>: <a href="mailto:eg%40gaute.vetsj.com">eg@gaute.vetsj.com</a></li>
<li><em>Delivered-to</em>: <a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a></li>
<li><em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=gamma;	h=domainkey-signature:mime-version:in-reply-to:references:date	:message-id:subject:from:to:content-type;	bh=uBfHxnwPmcXrym2dRbf/BHzfl5dQPp4YIrkHlVFWzRw=;	b=CJaVQWRQ2M3AUrjtExE0CDMXbZdHhCF8crw9szJP1husTyC4boRSE3eCO3OLAeD+su	4FvOwVS1AG+C9kpL9ajxTfUOHeJuIWN57zf38Kxjs+JcYfzBold0paoRLdxKwklrzDSm	MFN/nm+vXwt9Bpyehcz2cZrFMowdurnZT7diE=</li>
<li><em>Domainkey-signature</em>: a=rsa-sha1; c=nofws; d=gmail.com; s=gamma;	h=mime-version:in-reply-to:references:date:message-id:subject:from:to	:content-type;	b=Ew3foTtIgfsjZblZH2fCNUI55P4J6S5d3CVmQhnTIyqJvHsaBngUu3QvFkMhTj1Q/I	pCkZ1nWpl62Kjv+ov/MGx7RQ7a5r8WyYCqeuFxxaSJYpMSNKs/L+t5PApgrlwfPIWR26	LF174YCpVPQ76e1mHsmVw0wDFb666MvKw1ECU=</li>
<li><em>In-reply-to</em>: &lt;<a href="msg00611.html">1304460745-sup-6241@masanjin.net</a>&gt;</li>
<li><em>List-archive</em>: &lt;<a href="http://rubyforge.org/pipermail/sup-devel">http://rubyforge.org/pipermail/sup-devel</a>&gt;</li>
<li><em>List-help</em>: &lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=help">mailto:sup-devel-request@rubyforge.org?subject=help</a>&gt;</li>
<li><em>List-id</em>: Sup developer discussion &lt;sup-devel.rubyforge.org&gt;</li>
<li><em>List-post</em>: &lt;<a href="mailto:sup-devel@rubyforge.org">mailto:sup-devel@rubyforge.org</a>&gt;</li>
<li><em>List-subscribe</em>: &lt;<a href="http://rubyforge.org/mailman/listinfo/sup-devel">http://rubyforge.org/mailman/listinfo/sup-devel</a>&gt;,	&lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=subscribe">mailto:sup-devel-request@rubyforge.org?subject=subscribe</a>&gt;</li>
<li><em>List-unsubscribe</em>: &lt;<a href="http://rubyforge.org/mailman/options/sup-devel">http://rubyforge.org/mailman/options/sup-devel</a>&gt;,	&lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=unsubscribe">mailto:sup-devel-request@rubyforge.org?subject=unsubscribe</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg00765.html">201104251023.19659.hsanson@gmail.com</a>&gt;	&lt;<a href="msg00613.html">1303793294-sup-688@masanjin.net</a>&gt;	&lt;<a href="msg00546.html">1304052708-sup-4240@masanjin.net</a>&gt;	&lt;<a href="msg00515.html">BANLkTim9PigP91LaDQ6UG2_prxncYv1zEA@mail.gmail.com</a>&gt;	&lt;BANLkTi=ObuZiHWGs7Mtvh8J5k4J3KTxgMA@mail.gmail.com&gt;	&lt;BANLkTi=tSnbEijoEHG76Z5Fy9-3G4TPxVw@mail.gmail.com&gt;	&lt;<a href="msg00611.html">1304460745-sup-6241@masanjin.net</a>&gt;</li>
<li><em>Reply-to</em>: Sup developer discussion &lt;<a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a>&gt;</li>
<li><em>Sender</em>: <a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a></li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Chasen is the worst tokenizer, is pretty old. The best one is MeCab
that is the faster and from the same author of Chasen.
You can see all major Japanese tokenizer in action at this URL:
<a  rel="nofollow" href="http://nomadscafe.jp/test/keitaiso/index.cgi">http://nomadscafe.jp/test/keitaiso/index.cgi</a>. Just put some
text in the box and press the button.

After some hacking I got a Heliotrope server that works perfectly with
Japanese text. All I did was follow your comments
and applied the MeCab tokenizer to the message body and query strings
before passing them to Whistelpig or more specific
to Heliotrope::Index.

There is one problem I don't see how to handle... I do receive email
in Japanese but also Chinese and Korean. I need a different
tokenizer for each one and I have no idea how to handle this. Do email
messages contain a language header that would allow me
to identify the language and pass it to the corresponding tokenizer??


regards,
Horacio

On Wed, May 4, 2011 at 7:26 AM, William Morgan &lt;wmorgan-sup@masanjin.net&gt; wrote:
&gt; Reformatted excerpts from Horacio Sanson's message of 2011-05-03:
&gt;&gt; index = Index.new &quot;index&quot; =&gt; #&lt;Whistlepig::Index:0x00000002093f60&gt;
&gt;&gt; entry1 = Entry.new =&gt; #&lt;Whistlepig::Entry:0x0000000207d328&gt;
&gt;&gt; entry1.add_string &quot;body&quot;, &quot;&#x7814;&#x7A76;&#x4F1A;&quot; =&gt; #&lt;Whistlepig::Entry:0x0000000207d328&gt;
&gt;&gt; docid1 = index.add_entry entry1 =&gt; 1
&gt;&gt; q1 = Query.new &quot;body&quot;, &quot;&#x7814;&#x7A76;&quot; =&gt; body:&quot;&#x7814;&#x7A76;&quot;
&gt;&gt; results1 = index.search q1 =&gt; []
&gt;
&gt; The problem here is tokenization. Whistlepig only provides a very simple
&gt; tokenizer, namely, it looks for space-separated things [1]. So you have to
&gt; space-separate your tokens in both the indexing and querying stages, e.g.:
&gt;
&gt; &#xA0;entry1.add_string &quot;body&quot;, &quot;&#x7814; &#x7A76; &#x4F1A;&quot; =&gt; #&lt;Whistlepig::Entry:0x90b873c&gt;
&gt; &#xA0;docid1 = index.add_entry entry1 &#xA0; &#xA0; &#xA0;=&gt; 1
&gt; &#xA0;q1 = Query.new &quot;body&quot;, &quot;&#x7814; &#x7A76;&quot; &#xA0; &#xA0; &#xA0; =&gt; AND body:&quot;&#x7814;&quot; body:&quot;&#x7A76;&quot;
&gt; &#xA0;q1 = Query.new &quot;body&quot;, &quot;\&quot;&#x7814; &#x7A76;\&quot;&quot; &#xA0; =&gt; PHRASE body:&quot;&#x7814;&quot; body:&quot;&#x7A76;&quot;
&gt; &#xA0;results1 = index.search q1 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; =&gt; [1]
&gt;
&gt; For Japanese, proper tokenization is tricky. You could simply space-separate
&gt; every character and deal with the spurious matches across word boundaries.
&gt; Or you could do it right by plugging in a proper tokenizer, e.g. something
&gt; like <a  rel="nofollow" href="http://www.chasen.org/~taku/software/TinySegmenter/">http://www.chasen.org/~taku/software/TinySegmenter/</a>.
&gt;
&gt; [1] It also strips any prefix or suffix characters that match [:punct:]. This
&gt; is all pretty ad-hoc and undocumented. Providing simpler whitespace-only
&gt; tokenizer as an alternative is in the works.
&gt; --
&gt; William &lt;wmorgan-sup@masanjin.net&gt;
&gt; _______________________________________________
&gt; Sup-devel mailing list
&gt; Sup-devel@rubyforge.org
&gt; <a  rel="nofollow" href="http://rubyforge.org/mailman/listinfo/sup-devel">http://rubyforge.org/mailman/listinfo/sup-devel</a>
&gt;
</pre><pre>From f484b09518db47a06690e09a710cf6e866c5561b Mon Sep 17 00:00:00 2001
From: Horacio Sanson &lt;hsanson@gmail.com&gt;
Date: Wed, 4 May 2011 10:31:12 +0900
Subject: [PATCH 1/2] Fix crash for non ASCII chars

---
 bin/heliotrope-server |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/bin/heliotrope-server b/bin/heliotrope-server
index 4793ac2..ed9c3be 100644
--- a/bin/heliotrope-server
+++ b/bin/heliotrope-server
@@ -151,7 +151,7 @@ class HeliotropeServer &lt; Sinatra::Base
       nav += &quot;&lt;/div&gt;&quot;
 
       header(&quot;Search: #{query.original_query_s}&quot;, query.original_query_s) +
-        &quot;&lt;div&gt;Parsed query: #{escape_html query.parsed_query_s}&lt;/div&gt;&quot; +
+        &quot;&lt;div&gt;Parsed query: #{escape_html query.parsed_query_s.force_encoding('UTF-8')}&lt;/div&gt;&quot; +
         &quot;&lt;div&gt;Search took #{sprintf '%.2f', info[:elapsed]}s and #{info[:continued] ? 'was' : 'was NOT'} continued&lt;/div&gt;&quot; +
         &quot;#{nav}&lt;table&gt;&quot; +
         results.map { |r| threadinfo_to_html r }.join +
-- 
1.7.4.1

</pre><pre>From 6595af0b55d52d1f68562fbdd0f1b23dfee34039 Mon Sep 17 00:00:00 2001
From: Horacio Sanson &lt;hsanson@gmail.com&gt;
Date: Wed, 4 May 2011 10:34:48 +0900
Subject: [PATCH 2/2] Add MeCab japanese text analyzer.

Japanese text has no white space separation causing the Whistelpig
tokenizer to fail. This patch processes the email indexable text
and search queries with MeCab before passing them to Whistelpig.
---
 bin/heliotrope-server     |    3 ++-
 lib/heliotrope/message.rb |    5 +++--
 2 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/bin/heliotrope-server b/bin/heliotrope-server
index ed9c3be..f3bd5d4 100644
--- a/bin/heliotrope-server
+++ b/bin/heliotrope-server
@@ -67,6 +67,7 @@ class HeliotropeServer &lt; Sinatra::Base
     end.to_json
   end
 
+  require &quot;MeCab&quot;
   def get_query_from_params
     ## work around a rack (?) bug where quotes are omitted in queries like &quot;hello bob&quot;
     query = if env[&quot;rack.request.query_string&quot;] =~ /\bq=(.+?)(&amp;|$)/
@@ -76,7 +77,7 @@ class HeliotropeServer &lt; Sinatra::Base
     end
 
     raise RequestError, &quot;need a query&quot; unless query
-    query
+    MeCab::Tagger.new(&quot;-Owakati&quot;).parse(query).force_encoding(&quot;UTF-8&quot;)
   end
 
   def get_search_results
diff --git a/lib/heliotrope/message.rb b/lib/heliotrope/message.rb
index b48329b..e61d8bd 100644
--- a/lib/heliotrope/message.rb
+++ b/lib/heliotrope/message.rb
@@ -76,6 +76,7 @@ class Message
   def indirect_recipients; cc + bcc end
   def recipients; direct_recipients + indirect_recipients end
 
+  require &quot;MeCab&quot;
   def indexable_text
     @indexable_text ||= begin
       v = ([from.indexable_text] +
@@ -90,8 +91,8 @@ class Message
         end
       ).flatten.compact.join(&quot; &quot;)
 
-      v.gsub(/\s+[\W\d_]+(\s|$)/, &quot; &quot;). # drop funny tokens
-        gsub(/\s+/, &quot; &quot;)
+      MeCab::Tagger.new(&quot;-Owakati&quot;).parse(v)   # Tokenize Japanese Text
+        .gsub(/\s+/, &quot; &quot;)
     end
   end
 
-- 
1.7.4.1

</pre><pre>_______________________________________________
Sup-devel mailing list
Sup-devel@rubyforge.org
<a  rel="nofollow" href="http://rubyforge.org/mailman/listinfo/sup-devel">http://rubyforge.org/mailman/listinfo/sup-devel</a>
</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00508" href="msg00508.html">Re: [sup-devel] Cannot query Japanese characters</a></strong>
<ul><li><em>From:</em> Horacio Sanson &lt;hsanson@gmail.com&gt;</li></ul></li>
<li><strong><a name="00772" href="msg00772.html">Re: [sup-devel] Cannot query Japanese characters</a></strong>
<ul><li><em>From:</em> William Morgan &lt;wmorgan-sup@masanjin.net&gt;</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00765" href="msg00765.html">[sup-devel] Cannot query Japanese characters</a></strong>
<ul><li><em>From:</em> Horacio Sanson &lt;hsanson@gmail.com&gt;</li></ul></li>
<li><strong><a name="00613" href="msg00613.html">Re: [sup-devel] Cannot query Japanese characters</a></strong>
<ul><li><em>From:</em> William Morgan &lt;wmorgan-sup@masanjin.net&gt;</li></ul></li>
<li><strong><a name="00546" href="msg00546.html">Re: [sup-devel] Cannot query Japanese characters</a></strong>
<ul><li><em>From:</em> William Morgan &lt;wmorgan-sup@masanjin.net&gt;</li></ul></li>
<li><strong><a name="00515" href="msg00515.html">Re: [sup-devel] Cannot query Japanese characters</a></strong>
<ul><li><em>From:</em> Horacio Sanson &lt;hsanson@gmail.com&gt;</li></ul></li>
<li><strong><a name="00746" href="msg00746.html">Re: [sup-devel] Cannot query Japanese characters</a></strong>
<ul><li><em>From:</em> Horacio Sanson &lt;hsanson@gmail.com&gt;</li></ul></li>
<li><strong><a name="00747" href="msg00747.html">Re: [sup-devel] Cannot query Japanese characters</a></strong>
<ul><li><em>From:</em> Horacio Sanson &lt;hsanson@gmail.com&gt;</li></ul></li>
<li><strong><a name="00611" href="msg00611.html">Re: [sup-devel] Cannot query Japanese characters</a></strong>
<ul><li><em>From:</em> William Morgan &lt;wmorgan-sup@masanjin.net&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00508.html">Re: [sup-devel] Cannot query Japanese characters</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00573.html">[sup-devel] multi-account setup and other annoyances</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00611.html">Re: [sup-devel] Cannot query Japanese characters</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00508.html">Re: [sup-devel] Cannot query Japanese characters</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#00623"><strong>Date</strong></a></li>
<li><a href="threads.html#00623"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</body>
</html>
