<!-- MHonArc v2.6.18 -->
<!--X-Subject: [sup&#45;devel] [PATCH] gpg related fixes (resubmitted) -->
<!--X-From-R13: Vnzvfu R <qzvfuqNtznvy.pbz> -->
<!--X-Date: Mon, 18 Oct 2010 11:43:41 &#45;0700 (PDT) -->
<!--X-Message-Id: AANLkTimE2P7oMB6qkD=davoTghvp1t2vMhhHixG74waV@mail.gmail.com -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>[sup-devel] [PATCH] gpg related fixes (resubmitted)</title>
<link rev="made" href="mailto:dmishd@gmail.com">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<a href="msg00696.html">Date Prev</a>][<a href="msg00521.html">Date Next</a>][<a href="msg00696.html">Thread Prev</a>][<a href="msg00547.html">Thread Next</a>][<a href="maillist.html#00441">Date Index</a>][<a href="threads.html#00441">Thread Index</a>]
<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>[sup-devel] [PATCH] gpg related fixes (resubmitted)</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: <a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a></li>
<li><em>Subject</em>: [sup-devel] [PATCH] gpg related fixes (resubmitted)</li>
<li><em>From</em>: Hamish D &lt;<a href="mailto:dmishd%40gmail.com">dmishd@gmail.com</a>&gt;</li>
<li><em>Date</em>: Mon, 18 Oct 2010 19:43:26 +0100</li>
<li><em>Authentication-results</em>: mx.google.com; spf=pass (google.com: domain of <a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a> designates 205.234.109.19 as permitted sender) smtp.mail=<a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a>; dkim=neutral (body hash did not verify) header.i=@gmail.com</li>
<li><em>Delivered-to</em>: <a href="mailto:eg%40gaute.vetsj.com">eg@gaute.vetsj.com</a></li>
<li><em>Delivered-to</em>: <a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a></li>
<li><em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=gamma;	h=domainkey-signature:mime-version:received:received:date:message-id	:subject:from:to:content-type;	bh=ijLyvlVOifsEwdsbQPksRaZypz/eEygYiFuejR7yOx4=;	b=CzuNz88uS5OyKBCDcYBpMkU4OrwYHR0ev3ZkNUA6cs0PbeXaCxGpc9mF4iTUtY5T5M	VIsjMfHvVf+FqF7OU8YDc7dgCHdWfnJKfzfPnDwq1euEUNlPvpyMUOg07sIcZBbMh/GZ	svJRwSebq2xjGtk/EBL8gWvceSxkiXkncVZ9g=</li>
<li><em>Domainkey-signature</em>: a=rsa-sha1; c=nofws; d=gmail.com; s=gamma;	h=mime-version:date:message-id:subject:from:to:content-type;	b=oicjTPPc/Jq966Fhi1A4RN1irbj+3wR301jTwxPeUVHe0LmwvA9486x24R/SyZDpTR	/+yrK/oyJX0c0OEHDsnEqNWNLb4zQOYWXsBAFp3Zggt8o+dH8ui3gJC8wkK1M3WvQiQ0	HkS49CS3SfEjN9qm6SwzjE5oqEMPeeCwHFPVU=</li>
<li><em>List-archive</em>: &lt;<a href="http://rubyforge.org/pipermail/sup-devel">http://rubyforge.org/pipermail/sup-devel</a>&gt;</li>
<li><em>List-help</em>: &lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=help">mailto:sup-devel-request@rubyforge.org?subject=help</a>&gt;</li>
<li><em>List-id</em>: Sup developer discussion &lt;sup-devel.rubyforge.org&gt;</li>
<li><em>List-post</em>: &lt;<a href="mailto:sup-devel@rubyforge.org">mailto:sup-devel@rubyforge.org</a>&gt;</li>
<li><em>List-subscribe</em>: &lt;<a href="http://rubyforge.org/mailman/listinfo/sup-devel">http://rubyforge.org/mailman/listinfo/sup-devel</a>&gt;,	&lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=subscribe">mailto:sup-devel-request@rubyforge.org?subject=subscribe</a>&gt;</li>
<li><em>List-unsubscribe</em>: &lt;<a href="http://rubyforge.org/mailman/options/sup-devel">http://rubyforge.org/mailman/options/sup-devel</a>&gt;,	&lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=unsubscribe">mailto:sup-devel-request@rubyforge.org?subject=unsubscribe</a>&gt;</li>
<li><em>Reply-to</em>: Sup developer discussion &lt;<a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a>&gt;</li>
<li><em>Sender</em>: <a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a></li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>I am resubmitting these patches. 0001-Give-gpg-a-known-suffix.patch
and 0001-Stop-worrying-notice-when-no-signature-present.patch are two
patches to replace the previous
0001-Stop-worrying-notice-when-no-signature-present.patch, though note
the known suffix patch is required for the second one to work.

And I didn't put [PATCH] in the subject line when I posted
0001-Deal-with-r-n-inside-encrypted-messages.patch so I'm attaching it
to this email in case the last one was missed due to workflow etc.

Hamish Downer
</pre><pre>From 1c8cbcf77666c9cbe918876889a73e6db08a45ae Mon Sep 17 00:00:00 2001
From: Hamish Downer &lt;dmishd@gmail.com&gt;
Date: Sun, 17 Oct 2010 19:48:36 +0100
Subject: [PATCH] Deal with &quot;\r\n&quot; inside encrypted messages

RMail expects &quot;\n\n&quot; to be the dividing line between the header and
body, but sometimes the decrypted message has &quot;\r\n&quot; as line ending
so the RMail parsing does not work. This commit fixes that.
---
 lib/sup/crypto.rb |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/lib/sup/crypto.rb b/lib/sup/crypto.rb
index 386dbb8..3069483 100644
--- a/lib/sup/crypto.rb
+++ b/lib/sup/crypto.rb
@@ -170,6 +170,10 @@ EOS
       end
       msg.body = output
     else
+      # It appears that some clients use Windows new lines - CRLF - but RMail
+      # splits the body and header on &quot;\n\n&quot;. So to allow the parse below to 
+      # succeed, we will convert the newlines to what RMail expects
+      output = output.gsub(/\r\n/, &quot;\n&quot;)
       # This is gross. This decrypted payload could very well be a multipart
       # element itself, as opposed to a simple payload. For example, a
       # multipart/signed element, like those generated by Mutt when encrypting
-- 
1.7.1

</pre><pre>From f2cfc432879d6fe103f0327078ca70984a7eeb06 Mon Sep 17 00:00:00 2001
From: Hamish Downer &lt;dmishd@gmail.com&gt;
Date: Mon, 18 Oct 2010 19:35:41 +0100
Subject: [PATCH] Give gpg a known suffix

Give gpg a file to decrypt ending in &quot;.asc&quot; to stop gpg complaining
about &quot;unknown suffix&quot;.
---
 lib/sup/crypto.rb |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/lib/sup/crypto.rb b/lib/sup/crypto.rb
index 386dbb8..4222b8d 100644
--- a/lib/sup/crypto.rb
+++ b/lib/sup/crypto.rb
@@ -139,7 +139,7 @@ EOS
   def decrypt payload, armor=false # a RubyMail::Message object
     return unknown_status(cant_find_binary) unless @cmd
 
-    payload_fn = Tempfile.new &quot;redwood.payload&quot;
+    payload_fn = Tempfile.new([&quot;redwood.payload&quot;, &quot;.asc&quot;])
     payload_fn.write payload.to_s
     payload_fn.close
 
-- 
1.7.1

</pre><pre>From 38e01f89178f06c3a29d494b56fe28c0aa82de81 Mon Sep 17 00:00:00 2001
From: Hamish Downer &lt;dmishd@gmail.com&gt;
Date: Sun, 17 Oct 2010 23:25:20 +0100
Subject: [PATCH] Stop worrying notice when no signature present

When no signature is present, there was a message saying
&quot;Unable to determine validity of cryptographic signature&quot;.
This fix means that if there are no error messages and no
messages about signature verification then the message is
assumed to not be signed at all. This fix also saves the
encrypted messages to a temp file with a suffix of .asc
to stop gpg complaining about &quot;unknown suffix&quot;.
---
 lib/sup/crypto.rb |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/lib/sup/crypto.rb b/lib/sup/crypto.rb
index 386dbb8..fd4c91c 100644
--- a/lib/sup/crypto.rb
+++ b/lib/sup/crypto.rb
@@ -108,6 +108,9 @@ EOS
       else
         Chunk::CryptoNotice.new :invalid, $1, output_lines
       end
+    elsif output_lines.length == 0 &amp;&amp; rc == 0
+      # the message wasn't signed
+      Chunk::CryptoNotice.new :valid, &quot;Encrypted message wasn't signed&quot;, output_lines
     else
       unknown_status output_lines
     end
@@ -139,7 +142,7 @@ EOS
   def decrypt payload, armor=false # a RubyMail::Message object
     return unknown_status(cant_find_binary) unless @cmd
 
-    payload_fn = Tempfile.new &quot;redwood.payload&quot;
+    payload_fn = Tempfile.new([&quot;redwood.payload&quot;, &quot;.asc&quot;])
     payload_fn.write payload.to_s
     payload_fn.close
 
-- 
1.7.1

</pre><pre>_______________________________________________
Sup-devel mailing list
Sup-devel@rubyforge.org
<a  rel="nofollow" href="http://rubyforge.org/mailman/listinfo/sup-devel">http://rubyforge.org/mailman/listinfo/sup-devel</a>
</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00547" href="msg00547.html">Re: [sup-devel] [PATCH] gpg related fixes (resubmitted)</a></strong>
<ul><li><em>From:</em> Rich Lane &lt;rlane@club.cc.cmu.edu&gt;</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00696.html">Re: [sup-devel] [PATCH] Stop worrying notice when encrypted email	not signed</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00521.html">[sup-devel]	[PATCH] Bugfix: Don&#x2019;t call handle&#xFFFD;added&#xFFFD;message for old messages with a new location</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00696.html">Re: [sup-devel] [PATCH] Stop worrying notice when encrypted email	not signed</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00547.html">Re: [sup-devel] [PATCH] gpg related fixes (resubmitted)</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#00441"><strong>Date</strong></a></li>
<li><a href="threads.html#00441"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</body>
</html>
