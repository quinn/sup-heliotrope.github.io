<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: [sup&#45;devel] rmail gem is faulty -->
<!--X-From-R13: [ngguvrh Dnxbgbwnban <zngguvrh.enxbgbwnbanNtznvy.pbz> -->
<!--X-Date: Fri, 18 Nov 2011 11:42:42 &#45;0800 (PST) -->
<!--X-Message-Id: CAMiZLn1v6PQ75Hfdb9PO+Aw4PZNjakkkVUkgScP6CStC8WYAsw@mail.gmail.com -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Reference: CAMiZLn2&#45;xTSReSjgHwkD2ppaNdm6mwwHmig47P6GpuKajiL6tw@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: [sup-devel] rmail gem is faulty</title>
<link rev="made" href="mailto:matthieu.rakotojaona@gmail.com">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<a href="msg00176.html">Date Prev</a>][<a href="msg00142.html">Date Next</a>][<a href="msg00176.html">Thread Prev</a>][<a href="msg00142.html">Thread Next</a>][<a href="maillist.html#00222">Date Index</a>][<a href="threads.html#00222">Thread Index</a>]
<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [sup-devel] rmail gem is faulty</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: sup-devel &lt;<a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a>&gt;</li>
<li><em>Subject</em>: Re: [sup-devel] rmail gem is faulty</li>
<li><em>From</em>: Matthieu Rakotojaona &lt;<a href="mailto:matthieu.rakotojaona%40gmail.com">matthieu.rakotojaona@gmail.com</a>&gt;</li>
<li><em>Date</em>: Fri, 18 Nov 2011 20:19:23 +0100</li>
<li><em>Authentication-results</em>: mx.google.com; spf=pass (google.com: domain of <a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a> designates 205.234.109.19 as permitted sender) smtp.mail=<a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a>; dkim=neutral (body hash did not verify) header.i=@gmail.com</li>
<li><em>Delivered-to</em>: <a href="mailto:eg%40gaute.vetsj.com">eg@gaute.vetsj.com</a></li>
<li><em>Delivered-to</em>: <a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a></li>
<li><em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=gamma;	h=mime-version:in-reply-to:references:from:date:message-id:subject:to	:content-type; bh=cFZfGr3zzN62qk/VtOW7dtN/ZoXnCFgmLPnvBJqkbMQ=;	b=EGKxEtnxtVRemRmfpQPRQLoRuC5yTDlhWf2yd8/fFU+jIln1z1M2HdMcrKzFL6507b	yhQfDSUyEAw8kKJ9bmgPX3TGgO739wkAJcewvQ9ag66i1imjAdKohe1oFOfefebBOXQE	RdKWKXEt8bzo87l3SOblfE2PRHzvZFaQB5grQ=</li>
<li><em>In-reply-to</em>: &lt;<a href="msg00176.html">CAMiZLn2-xTSReSjgHwkD2ppaNdm6mwwHmig47P6GpuKajiL6tw@mail.gmail.com</a>&gt;</li>
<li><em>List-archive</em>: &lt;<a href="http://rubyforge.org/pipermail/sup-devel">http://rubyforge.org/pipermail/sup-devel</a>&gt;</li>
<li><em>List-help</em>: &lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=help">mailto:sup-devel-request@rubyforge.org?subject=help</a>&gt;</li>
<li><em>List-id</em>: Sup developer discussion &lt;sup-devel.rubyforge.org&gt;</li>
<li><em>List-post</em>: &lt;<a href="mailto:sup-devel@rubyforge.org">mailto:sup-devel@rubyforge.org</a>&gt;</li>
<li><em>List-subscribe</em>: &lt;<a href="http://rubyforge.org/mailman/listinfo/sup-devel">http://rubyforge.org/mailman/listinfo/sup-devel</a>&gt;,	&lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=subscribe">mailto:sup-devel-request@rubyforge.org?subject=subscribe</a>&gt;</li>
<li><em>List-unsubscribe</em>: &lt;<a href="http://rubyforge.org/mailman/options/sup-devel">http://rubyforge.org/mailman/options/sup-devel</a>&gt;,	&lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=unsubscribe">mailto:sup-devel-request@rubyforge.org?subject=unsubscribe</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg00176.html">CAMiZLn2-xTSReSjgHwkD2ppaNdm6mwwHmig47P6GpuKajiL6tw@mail.gmail.com</a>&gt;</li>
<li><em>Reply-to</em>: Sup developer discussion &lt;<a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a>&gt;</li>
<li><em>Sender</em>: <a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a></li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On Fri, Nov 18, 2011 at 8:17 PM, Matthieu Rakotojaona
&lt;matthieu.rakotojaona@gmail.com&gt; wrote:
&gt; The result is the patch enclosed. All I did was in
&gt; lib/heliotrope/message.rb, so everything else works (mainly).

Hem.

-- 
Matthieu RAKOTOJAONA
</pre><pre>From 62772e81b01169803eb9647342523e8149e2175d Mon Sep 17 00:00:00 2001
From: rakoo &lt;matthieu.rakotojaona@gmail.com&gt;
Date: Fri, 18 Nov 2011 19:23:23 +0100
Subject: [PATCH] modified message.rb to use 'mail' gem

Before we used rmail, but it is not maintained anymore and faulty
---
 lib/heliotrope/message.rb |  110 ++++++++++++++++++++++++++++-----------------
 1 files changed, 69 insertions(+), 41 deletions(-)

diff --git a/lib/heliotrope/message.rb b/lib/heliotrope/message.rb
index fd83cee..f7cf0e7 100644
--- a/lib/heliotrope/message.rb
+++ b/lib/heliotrope/message.rb
@@ -1,10 +1,23 @@
 # encoding: UTF-8
 
-require 'rmail'
+require 'mail'
 require 'digest/md5'
 require 'json'
 require 'timeout'
 
+module Mail
+class Message
+	def fetch value
+		if self[value].nil?
+			return nil
+		else
+			return self[value].decoded.to_s
+		end
+	end
+end
+end
+
+
 module Heliotrope
 class InvalidMessageError &lt; StandardError; end
 class Message
@@ -14,42 +27,61 @@ class Message
   end
 
   def parse!
-    @m = RMail::Parser.read @rawbody
+    @m = Mail.read_from_string @rawbody
 
-    @msgid = find_msgids(decode_header(validate_field(:message_id, @m.header[&quot;message-id&quot;]))).first
-    ## this next error happens if we have a field, but we can't find a &lt;something&gt; in it
-    raise InvalidMessageError, &quot;can't parse msgid: #{@m.header['message-id']}&quot; unless @msgid
+		@msgid = @m[:message_id].message_id
+		## this next error happens if we have a field, but we can't find a &lt;something&gt; in it
+    raise InvalidMessageError, &quot;can't parse msgid: #{@m[:message_id].message_id}&quot; unless @msgid
     @safe_msgid = munge_msgid @msgid
 
-    @from = Person.from_string decode_header(validate_field(:from, @m.header[&quot;from&quot;]))
+		# From can contain multiple mailboxes. If it does, it MUST contain a
+		# Sender: field, which we will use. If it does not, it doesn't respect
+		# RFC5322, but we will use the first email address of the From: header
+		@from = 
+			if @m[:from].addresses.size &gt; 1
+				if @m[:sender].nil?
+					Person.from_string validate_field(:from, @m[:from].formatted.first.to_s)
+				else
+					Person.from_string validate_field(:sender, @m[:sender].formatted.first.to_s)
+				end
+			else
+				Person.from_string validate_field(:from, @m[:from].decoded.to_s)
+			end
+		
+		@sender = begin 
+			Person.from_string validate_field(:sender, @m[:sender].formatted.first.to_s) unless @m[:sender].nil?
+		rescue InvalidMessageError
+			&quot;&quot;
+		end
+
     @date = begin
-      Time.parse(validate_field(:date, @m.header[&quot;date&quot;])).to_i
+			Time.parse(@m.date.to_s).to_i
     rescue ArgumentError
       #puts &quot;warning: invalid date field #{@m.header['date']}&quot;
       0
     end
 
-    @to = Person.many_from_string decode_header(@m.header[&quot;to&quot;])
-    @cc = Person.many_from_string decode_header(@m.header[&quot;cc&quot;])
-    @bcc = Person.many_from_string decode_header(@m.header[&quot;bcc&quot;])
-    @subject = decode_header @m.header[&quot;subject&quot;]
-    @reply_to = Person.from_string @m.header[&quot;reply-to&quot;]
+		@to = @m[:to].nil? ? [] : Person.many_from_string(@m[:to].decoded.to_s)
+		@cc = @m[:cc].nil? ? [] : Person.many_from_string(m[:cc].decoded.to_s)
+		@bcc = @m[:bcc].nil? ? [] : Person.many_from_string(@m[:bcc].decoded.to_s)
+
+		@subject = @m.subject || &quot;&quot; #we can store and retrieve UTF-8 ...
 
-    @refs = find_msgids decode_header(@m.header[&quot;references&quot;] || &quot;&quot;)
-    in_reply_to = find_msgids decode_header(@m.header[&quot;in-reply-to&quot;] || &quot;&quot;)
-    @refs += in_reply_to unless @refs.member? in_reply_to.first
-    @safe_refs = @refs.map { |r| munge_msgid(r) }
+    @refs = @m[:references].nil? ? [] : @m[:references].message_ids.map{ |m| decode_header m} 
+		in_reply_to = @m[:in_reply_to].nil? ? [] : @m[:in_reply_to].message_ids{ |m| decode_header m}
+		@refs += in_reply_to unless @refs.member?(in_reply_to.first)
+		@safe_refs = @refs.nil? ? [] : @refs.map { |r| munge_msgid(r) }
 
     ## various other headers that you don't think we will need until we
     ## actually need them.
 
     ## this is sometimes useful for determining who was the actual target of
     ## the email, in the case that someone has aliases
-    @recipient_email = @m.header[&quot;envelope-to&quot;] || @m.header[&quot;x-original-to&quot;] || @m.header[&quot;delivered-to&quot;]
+    @recipient_email = @m.fetch(&quot;envelope-to&quot;) || @m.fetch(&quot;x-original-to&quot;) || @m.fetch(&quot;delivered-to&quot;)
 
-    @list_subscribe = @m.header[&quot;list-subscribe&quot;]
-    @list_unsubscribe = @m.header[&quot;list-unsubscribe&quot;]
-    @list_post = @m.header[&quot;list-post&quot;] || @m.header[&quot;x-mailing-list&quot;]
+    @list_subscribe = @m.fetch(&quot;list-subscribe&quot;)
+    @list_unsubscribe = @m.fetch(&quot;list-unsubscribe&quot;)
+    @list_post = @m.fetch(&quot;list-post&quot;) || @m.fetch(&quot;x-mailing-list&quot;)
 
     self
   end
@@ -90,8 +122,8 @@ class Message
   end
 
   def direct_recipients; to end
-  def indirect_recipients; cc + bcc end
-  def recipients; direct_recipients + indirect_recipients end
+  def indirect_recipients; (cc || []) + (bcc || []) end
+  def recipients; (direct_recipients || []) + (indirect_recipients || []) end
 
   def indexable_text
     @indexable_text ||= begin
@@ -128,12 +160,9 @@ class Message
     &quot;&quot;
   end
 
-  def has_attachment?
-    @has_attachment ||=
-      mime_parts(&quot;text/plain&quot;).any? do |type, fn, id, content|
-        fn &amp;&amp; (type !~ SIGNATURE_ATTACHMENT_TYPE)
-    end
-  end
+	def has_attachment?
+		@m.has_attachments? # defined in the mail gem
+	end
 
   def signed?
     @signed ||= mime_part_types.any? { |t| t =~ SIGNED_MIME_TYPE }
@@ -148,7 +177,7 @@ class Message
   end
 
 private
-
+	
   ## hash the fuck out of all message ids. trust me, you want this.
   def munge_msgid msgid
     Digest::MD5.hexdigest msgid
@@ -159,8 +188,8 @@ private
   end
 
   def mime_part_types part=@m
-    ptype = part.header[&quot;content-type&quot;] || &quot;&quot;
-    [ptype] + (part.multipart? ? part.body.map { |sub| mime_part_types sub } : [])
+    ptype = part.fetch(&quot;content-type&quot;) || &quot;&quot;
+    [ptype] + (part.multipart? ? part.body.parts.map { |sub| mime_part_types sub } : [])
   end
 
   ## unnests all the mime stuff and returns a list of [type, filename, content]
@@ -171,14 +200,14 @@ private
   def decode_mime_parts part, preferred_type, level=0
     if part.multipart?
       if mime_type_for(part) =~ /multipart\/alternative/
-        target = part.body.find { |p| mime_type_for(p).index(preferred_type) } || part.body.first
+        target = part.body.parts.find { |p| mime_type_for(p).index(preferred_type) } || part.body.first
         if target # this can be nil
           decode_mime_parts target, preferred_type, level + 1
         else
           []
         end
       else # decode 'em all
-        part.body.compact.map { |subpart| decode_mime_parts subpart, preferred_type, level + 1 }.flatten 1
+        part.body.parts.compact.map { |subpart| decode_mime_parts subpart, preferred_type, level + 1 }.flatten 1
       end
     else
       type = mime_type_for part
@@ -199,11 +228,11 @@ private
   end
 
   def mime_type_for part
-    (part.header[&quot;content-type&quot;] || &quot;text/plain&quot;).gsub(/\s+/, &quot; &quot;).strip.downcase
+    (part.fetch(&quot;content-type&quot;) || &quot;text/plain&quot;).gsub(/\s+/, &quot; &quot;).strip.downcase
   end
 
   def mime_id_for part
-    header = part.header[&quot;content-id&quot;]
+    header = part.fetch(&quot;content-id&quot;)
     case header
       when /&lt;(.+?)&gt;/; $1
       else header
@@ -212,8 +241,8 @@ private
 
   ## a filename, or nil
   def mime_filename_for part
-    cd = part.header[&quot;Content-Disposition&quot;]
-    ct = part.header[&quot;Content-Type&quot;]
+    cd = part.fetch(&quot;Content-Disposition&quot;)
+    ct = part.fetch(&quot;Content-Type&quot;)
 
     ## RFC 2183 (Content-Disposition) specifies that disposition-parms are
     ## separated by &quot;;&quot;. So, we match everything up to &quot; and ; (if present).
@@ -250,11 +279,10 @@ private
   def mime_content_for mime_part, preferred_type
     return &quot;&quot; unless mime_part.body # sometimes this happens. not sure why.
 
-    mt = mime_type_for(mime_part) || &quot;text/plain&quot; # i guess
-    content_type = if mt =~ /^(.+);/ then $1.downcase else mt end
-    source_charset = if mt =~ /charset=&quot;?(.*?)&quot;?(;|$)/i then $1 else &quot;US-ASCII&quot; end
+		content_type = mime_part.header[:content_type].nil? ? &quot;text/plain&quot; : mime_part.header[:content_type].string
+		source_charset = mime_part.charset || &quot;US-ASCII&quot;
 
-    content = mime_part.decode
+    content = mime_part.decoded
     converted_content, converted_charset = if(converter = CONVERSIONS[[content_type, preferred_type]])
       send converter, content, source_charset
     else
-- 
1.7.7.3

</pre><pre>_______________________________________________
Sup-devel mailing list
Sup-devel@rubyforge.org
<a  rel="nofollow" href="http://rubyforge.org/mailman/listinfo/sup-devel">http://rubyforge.org/mailman/listinfo/sup-devel</a>
</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00176" href="msg00176.html">[sup-devel] rmail gem is faulty</a></strong>
<ul><li><em>From:</em> Matthieu Rakotojaona &lt;matthieu.rakotojaona@gmail.com&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00176.html">[sup-devel] rmail gem is faulty</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00142.html">[sup-devel] Instructions for testing sup with recent ruby/gems</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00176.html">[sup-devel] rmail gem is faulty</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00142.html">[sup-devel] Instructions for testing sup with recent ruby/gems</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#00222"><strong>Date</strong></a></li>
<li><a href="threads.html#00222"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</body>
</html>
