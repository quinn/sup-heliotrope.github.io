<!-- MHonArc v2.6.18 -->
<!--X-Subject: [sup&#45;devel] [PATCH] Fix problem with time parsing -->
<!--X-From-R13: Vnzvfu <qzvfuqNtznvy.pbz> -->
<!--X-Date: Mon, 2 May 2011 15:03:03 &#45;0700 (PDT) -->
<!--X-Message-Id: 1304373710&#45;sup&#45;1383@whisper -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Derived: binUlV_kWy6CF.bin -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>[sup-devel] [PATCH] Fix problem with time parsing</title>
<link rev="made" href="mailto:dmishd@gmail.com">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<a href="msg00746.html">Date Prev</a>][<a href="msg00730.html">Date Next</a>][<a href="msg00689.html">Thread Prev</a>][<a href="msg00551.html">Thread Next</a>][<a href="maillist.html#00644">Date Index</a>][<a href="threads.html#00644">Thread Index</a>]
<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>[sup-devel] [PATCH] Fix problem with time parsing</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: sup-devel &lt;<a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a>&gt;</li>
<li><em>Subject</em>: [sup-devel] [PATCH] Fix problem with time parsing</li>
<li><em>From</em>: Hamish &lt;<a href="mailto:dmishd%40gmail.com">dmishd@gmail.com</a>&gt;</li>
<li><em>Date</em>: Mon, 02 May 2011 23:02:43 +0100</li>
<li><em>Authentication-results</em>: mx.google.com; spf=pass (google.com: domain of <a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a> designates 205.234.109.19 as permitted sender) smtp.mail=<a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a>; dkim=neutral (body hash did not verify) header.i=@gmail.com</li>
<li><em>Delivered-to</em>: <a href="mailto:eg%40gaute.vetsj.com">eg@gaute.vetsj.com</a></li>
<li><em>Delivered-to</em>: <a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a></li>
<li><em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=gamma;	h=domainkey-signature:subject:from:to:date:message-id:user-agent	:content-transfer-encoding:mime-version:content-type;	bh=xSiUyJXgbScAcQA9VZ8DPtJWuP4+pS9Euv4k5Db0DAI=;	b=nM4NbuaXFfVwDHNnxWh3RBy5goGevFyVRjOm9gJAdeYQNj8YYr3ZuIrtsxsPAQb6dT	hHRZmpbhSrGDdRVXGQfe9UoDE7jHNqeN2riv2RVbUJhMn0g1ZHgx85VzCogDzg5HEHP5	2F2Ayge7jnKHjM5sV2lzGAG4sbkQbOTULFdRg=</li>
<li><em>Domainkey-signature</em>: a=rsa-sha1; c=nofws; d=gmail.com; s=gamma;	h=subject:from:to:date:message-id:user-agent	:content-transfer-encoding:mime-version:content-type;	b=wrmZX1UJq5+GpQUtdmimRAshQLiB1tApOVS93wWCrdVlgg+sZPudPyfYqCe17YbzMm	IqhpXR1ZnCpmZwKFcFRy+4/PKjhvTGt2eHQLWPHFxIdNepOR6DgJeFuZp+q35oLTOJr6	R7XBKD0s7WN36eBC8xmxV5o9zDnz8nBXgiFaU=</li>
<li><em>List-archive</em>: &lt;<a href="http://rubyforge.org/pipermail/sup-devel">http://rubyforge.org/pipermail/sup-devel</a>&gt;</li>
<li><em>List-help</em>: &lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=help">mailto:sup-devel-request@rubyforge.org?subject=help</a>&gt;</li>
<li><em>List-id</em>: Sup developer discussion &lt;sup-devel.rubyforge.org&gt;</li>
<li><em>List-post</em>: &lt;<a href="mailto:sup-devel@rubyforge.org">mailto:sup-devel@rubyforge.org</a>&gt;</li>
<li><em>List-subscribe</em>: &lt;<a href="http://rubyforge.org/mailman/listinfo/sup-devel">http://rubyforge.org/mailman/listinfo/sup-devel</a>&gt;,	&lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=subscribe">mailto:sup-devel-request@rubyforge.org?subject=subscribe</a>&gt;</li>
<li><em>List-unsubscribe</em>: &lt;<a href="http://rubyforge.org/mailman/options/sup-devel">http://rubyforge.org/mailman/options/sup-devel</a>&gt;,	&lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=unsubscribe">mailto:sup-devel-request@rubyforge.org?subject=unsubscribe</a>&gt;</li>
<li><em>Reply-to</em>: Sup developer discussion &lt;<a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a>&gt;</li>
<li><em>Sender</em>: <a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a></li>
<li><em>User-agent</em>: Sup/git</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>If a message has a date with month first and day second, then if the
day is greater than 12, heliotrope crashes. This patch catches the
error, and tries again after swapping the day and month.
---
 lib/heliotrope/maildir-walker.rb |   14 +++++++++++++-
 1 files changed, 13 insertions(+), 1 deletions(-)

diff --git a/lib/heliotrope/maildir-walker.rb b/lib/heliotrope/maildir-walker.rb
index db9b9d4..47cb08b 100644
--- a/lib/heliotrope/maildir-walker.rb
+++ b/lib/heliotrope/maildir-walker.rb
@@ -43,7 +43,19 @@ private
       while(l = f.gets)
         if l =~ /^Date:\s+(.+\S)\s*$/
           date = $1
-          pdate = Time.parse($1)
+          begin
+            pdate = Time.parse($1)
+          rescue ArgumentError
+            # flip the day and month around and try again
+            if date =~ %r|(\d\d?)([-./])(\d\d?)([-./])(\d{2,4})|
+              date = $3 + $2 + $1 + $4 + $5
+              pdate = Time.parse(date)
+            else
+              puts &quot;Error while parsing time in file #{fn}&quot;
+              puts &quot;Matched date text was #{date}&quot;
+              pdate = Time.at 0
+            end
+          end
           return pdate
         end
       end
-- 
1.7.4.1
</pre><p><strong>Attachment:
<a href="binUlV_kWy6CF.bin" ><tt>0001-Fix-problem-with-time-parsing.patch</tt></a></strong><br>
<em>Description:</em> Binary data</p>
<pre>_______________________________________________
Sup-devel mailing list
Sup-devel@rubyforge.org
<a  rel="nofollow" href="http://rubyforge.org/mailman/listinfo/sup-devel">http://rubyforge.org/mailman/listinfo/sup-devel</a>
</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00551" href="msg00551.html">Re: [sup-devel] [PATCH] Fix problem with time parsing</a></strong>
<ul><li><em>From:</em> William Morgan &lt;wmorgan-sup@masanjin.net&gt;</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00746.html">Re: [sup-devel] Cannot query Japanese characters</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00730.html">[sup-devel] turnsole crash on start up</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00689.html">[sup-devel] odd - mime-decode not working on some text/html mails</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00551.html">Re: [sup-devel] [PATCH] Fix problem with time parsing</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#00644"><strong>Date</strong></a></li>
<li><a href="threads.html#00644"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</body>
</html>
