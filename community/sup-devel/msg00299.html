<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: [sup&#45;devel] Invalid meta data error in OklahomaMixer -->
<!--X-From-R13: Vbenpvb Enafba <ufnafbaNtznvy.pbz> -->
<!--X-Date: Mon, 13 Jun 2011 21:48:16 &#45;0700 (PDT) -->
<!--X-Message-Id: BANLkTi=CKJmvQ4G2djKikSeT3&#45;to4yPaDA@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: BANLkTi=5BQ6f0VPKq9ZhE6KNyXKS9ZMV3Q@mail.gmail.com -->
<!--X-Reference: 1308017442&#45;sup&#45;8849@masanjin.net -->
<!--X-Reference: 1308017654&#45;sup&#45;350@masanjin.net -->
<!--X-Reference: BANLkTikqVo2WLyOJ7jTdRgyBm9d3=DbRMw@mail.gmail.com -->
<!--X-Reference: 1308022018&#45;sup&#45;5391@masanjin.net -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: [sup-devel] Invalid meta data error in OklahomaMixer</title>
<link rev="made" href="mailto:hsanson@gmail.com">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<a href="msg00298.html">Date Prev</a>][<a href="msg00365.html">Date Next</a>][<a href="msg00298.html">Thread Prev</a>][<a href="msg00365.html">Thread Next</a>][<a href="maillist.html#00299">Date Index</a>][<a href="threads.html#00299">Thread Index</a>]
<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [sup-devel] Invalid meta data error in OklahomaMixer</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: Sup developer discussion &lt;<a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a>&gt;</li>
<li><em>Subject</em>: Re: [sup-devel] Invalid meta data error in OklahomaMixer</li>
<li><em>From</em>: Horacio Sanson &lt;<a href="mailto:hsanson%40gmail.com">hsanson@gmail.com</a>&gt;</li>
<li><em>Date</em>: Tue, 14 Jun 2011 13:21:56 +0900</li>
<li><em>Authentication-results</em>: mx.google.com; spf=pass (google.com: domain of <a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a> designates 205.234.109.19 as permitted sender) smtp.mail=<a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a>; dkim=neutral (body hash did not verify) header.i=@gmail.com</li>
<li><em>Delivered-to</em>: <a href="mailto:eg%40gaute.vetsj.com">eg@gaute.vetsj.com</a></li>
<li><em>Delivered-to</em>: <a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a></li>
<li><em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=gamma;	h=domainkey-signature:mime-version:in-reply-to:references:date	:message-id:subject:from:to:content-type;	bh=eDZKtTicLAwst2yf8yXG56ett3U2FGceZZIAlj9Yx1g=;	b=MOiYgg5AoWiZdrAgdJ/gSUPgjGibffaVvcNry1sYsF5yMxo84W92WZyeHfNqGoPYVJ	LyQBE5clEt6Oj3ST2yZ8a2mrLwTH7gUMcg8QoZa59sxyMc244uaR9mJdNnDZB3BfGL0k	CL4oWCpRIhmL2YRXFULNl6t8ZCq9HP9ot68hA=</li>
<li><em>Domainkey-signature</em>: a=rsa-sha1; c=nofws; d=gmail.com; s=gamma;	h=mime-version:in-reply-to:references:date:message-id:subject:from:to	:content-type;	b=KlXM52l2HjeqDC9aCy7hHIkOODtDgHP5WDq0JnocpJWc9Eh0HLGh5L6Z6dYKQRnzWT	EHDTWcSf2QzCPecxCT5CxG92IromvvaryhriAWKcmB1UOmRpu/D0IQX73tnan7ZTDvBx	v/6TV8ctOhFugEuOz8xf47WQ1gI7uNEwyN+o0=</li>
<li><em>In-reply-to</em>: &lt;<a href="msg00298.html">1308022018-sup-5391@masanjin.net</a>&gt;</li>
<li><em>List-archive</em>: &lt;<a href="http://rubyforge.org/pipermail/sup-devel">http://rubyforge.org/pipermail/sup-devel</a>&gt;</li>
<li><em>List-help</em>: &lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=help">mailto:sup-devel-request@rubyforge.org?subject=help</a>&gt;</li>
<li><em>List-id</em>: Sup developer discussion &lt;sup-devel.rubyforge.org&gt;</li>
<li><em>List-post</em>: &lt;<a href="mailto:sup-devel@rubyforge.org">mailto:sup-devel@rubyforge.org</a>&gt;</li>
<li><em>List-subscribe</em>: &lt;<a href="http://rubyforge.org/mailman/listinfo/sup-devel">http://rubyforge.org/mailman/listinfo/sup-devel</a>&gt;,	&lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=subscribe">mailto:sup-devel-request@rubyforge.org?subject=subscribe</a>&gt;</li>
<li><em>List-unsubscribe</em>: &lt;<a href="http://rubyforge.org/mailman/options/sup-devel">http://rubyforge.org/mailman/options/sup-devel</a>&gt;,	&lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=unsubscribe">mailto:sup-devel-request@rubyforge.org?subject=unsubscribe</a>&gt;</li>
<li><em>References</em>: &lt;BANLkTi=5BQ6f0VPKq9ZhE6KNyXKS9ZMV3Q@mail.gmail.com&gt;	&lt;<a href="msg00184.html">1308017442-sup-8849@masanjin.net</a>&gt;	&lt;<a href="msg00294.html">1308017654-sup-350@masanjin.net</a>&gt;	&lt;BANLkTikqVo2WLyOJ7jTdRgyBm9d3=DbRMw@mail.gmail.com&gt;	&lt;<a href="msg00298.html">1308022018-sup-5391@masanjin.net</a>&gt;</li>
<li><em>Reply-to</em>: Sup developer discussion &lt;<a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a>&gt;</li>
<li><em>Sender</em>: <a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a></li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>I managed to get the store.tch working again by installing
tokyocabinet-bin and running this command on the file:

  tchmgr optimize -nl store.tch   # without -nl nothing works...

at the end of this command I got a write error but the file got back
to a usable state. I am afraid this command simply truncated the file
causing some missing emails but not really sure. Is there a way to
check if the index and the messages are in sync? That is all indexed
messages have a corresponding email message in the store.tch?

Here is a good blog post with tips for using Tokyo Cabinet. It
recommends enabling logging and running optimize from time to time.
Logging would allow us to see what caused the metadata corruption:

  <a  rel="nofollow" href="http://www.bigdbahead.com/?p=700">http://www.bigdbahead.com/?p=700</a>

Some posts of people with the same invalid metadata problem:

  <a  rel="nofollow" href="http://twitter.com/#!/ono_matope/statuses/17650765308">http://twitter.com/#!/ono_matope/statuses/17650765308</a>
  <a  rel="nofollow" href="http://groups.google.com/group/tokyocabinet-users/browse_thread/thread/f114f078848e20ed">http://groups.google.com/group/tokyocabinet-users/browse_thread/thread/f114f078848e20ed</a>

Tokyo Cabinet is pretty good and is actually used for the largest
social network in Japan
(<a  rel="nofollow" href="http://alpha.mixi.co.jp/blog/?s=tchdb&amp;paged=2">http://alpha.mixi.co.jp/blog/?s=tchdb&amp;paged=2</a>) so I would not change
it. Even big databases (e.g. MySQL, Postgres and Oracle) are not free
of table corruption. The difference is that they provide tools to
detect and recover from such corruption state.

regards,
Horacio

On Tue, Jun 14, 2011 at 12:30 PM, William Morgan
&lt;wmorgan-sup@masanjin.net&gt; wrote:
&gt; Reformatted excerpts from Horacio Sanson's message of 2011-06-14:
&gt;&gt; Not even close... my store.tch is 76MB only. This metadata corruption
&gt;&gt; in Tokyo Cabinet seems to be a common occurrence and what is scary
&gt;&gt; about this is that there seems to be no way to recover from it (as far
&gt;&gt; as google can tell). The only option I see is delete my store/index
&gt;&gt; and restart sync again.
&gt;
&gt; Can you point me to some links about this type of corruption?
&gt;
&gt; I'm far from wedded to Oklahoma Mixer / Tokyo Cabinet. It was just the
&gt; easiest thing to get started with. Any kind of mutable persistent
&gt; key-value store will do. Other alternatives to consider: another
&gt; TokyoCabinet gem besides OH, KyotoCabinet, BDB... I kinda don't want to
&gt; move to separate processes like Redis though. If only there were a
&gt; libredis (well there is, but it's not what you want.)
&gt; --
&gt; William &lt;wmorgan-sup@masanjin.net&gt;
&gt; _______________________________________________
&gt; Sup-devel mailing list
&gt; Sup-devel@rubyforge.org
&gt; <a  rel="nofollow" href="http://rubyforge.org/mailman/listinfo/sup-devel">http://rubyforge.org/mailman/listinfo/sup-devel</a>
&gt;
_______________________________________________
Sup-devel mailing list
Sup-devel@rubyforge.org
<a  rel="nofollow" href="http://rubyforge.org/mailman/listinfo/sup-devel">http://rubyforge.org/mailman/listinfo/sup-devel</a>
</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00153" href="msg00153.html">[sup-devel] Invalid meta data error in OklahomaMixer</a></strong>
<ul><li><em>From:</em> Horacio Sanson &lt;hsanson@gmail.com&gt;</li></ul></li>
<li><strong><a name="00184" href="msg00184.html">Re: [sup-devel] Invalid meta data error in OklahomaMixer</a></strong>
<ul><li><em>From:</em> William Morgan &lt;wmorgan-sup@masanjin.net&gt;</li></ul></li>
<li><strong><a name="00294" href="msg00294.html">Re: [sup-devel] Invalid meta data error in OklahomaMixer</a></strong>
<ul><li><em>From:</em> William Morgan &lt;wmorgan-sup@masanjin.net&gt;</li></ul></li>
<li><strong><a name="00090" href="msg00090.html">Re: [sup-devel] Invalid meta data error in OklahomaMixer</a></strong>
<ul><li><em>From:</em> Horacio Sanson &lt;hsanson@gmail.com&gt;</li></ul></li>
<li><strong><a name="00298" href="msg00298.html">Re: [sup-devel] Invalid meta data error in OklahomaMixer</a></strong>
<ul><li><em>From:</em> William Morgan &lt;wmorgan-sup@masanjin.net&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00298.html">Re: [sup-devel] Invalid meta data error in OklahomaMixer</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00365.html">[sup-devel] Tokyo Cabinet fails with invalid record header</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00298.html">Re: [sup-devel] Invalid meta data error in OklahomaMixer</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00365.html">[sup-devel] Tokyo Cabinet fails with invalid record header</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#00299"><strong>Date</strong></a></li>
<li><a href="threads.html#00299"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</body>
</html>
