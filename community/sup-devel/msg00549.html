<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: [sup&#45;devel] editing messages outside of sup -->
<!--X-From-R13: Vnzvfu <qzvfuqNtznvy.pbz> -->
<!--X-Date: Sat, 26 Feb 2011 12:31:52 &#45;0800 (PST) -->
<!--X-Message-Id: 1298747943&#45;sup&#45;9749@whisper -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 1298239068&#45;sup&#45;6985@whisper -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: [sup-devel] editing messages outside of sup</title>
<link rev="made" href="mailto:dmishd@gmail.com">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<a href="msg00583.html">Date Prev</a>][<a href="msg00412.html">Date Next</a>][<a href="msg00577.html">Thread Prev</a>][<a href="msg00538.html">Thread Next</a>][<a href="maillist.html#00549">Date Index</a>][<a href="threads.html#00549">Thread Index</a>]
<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [sup-devel] editing messages outside of sup</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: sup-devel &lt;<a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a>&gt;</li>
<li><em>Subject</em>: Re: [sup-devel] editing messages outside of sup</li>
<li><em>From</em>: Hamish &lt;<a href="mailto:dmishd%40gmail.com">dmishd@gmail.com</a>&gt;</li>
<li><em>Date</em>: Sat, 26 Feb 2011 19:23:13 +0000</li>
<li><em>Authentication-results</em>: mx.google.com; spf=pass (google.com: domain of <a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a> designates 205.234.109.19 as permitted sender) smtp.mail=<a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a>; dkim=neutral (body hash did not verify) header.i=@gmail.com</li>
<li><em>Delivered-to</em>: <a href="mailto:eg%40gaute.vetsj.com">eg@gaute.vetsj.com</a></li>
<li><em>Delivered-to</em>: <a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a></li>
<li><em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=gamma;	h=domainkey-signature:content-type:subject:from:to:in-reply-to	:references:date:message-id:user-agent:content-transfer-encoding;	bh=/LmCsQX2fGx5L6iLjBYg7vCiwH4MsXqRun/peyjIxXc=;	b=cejQPbkDOVydEn5wkx+bEp76GOCRV0AQWMJdTS97hkzrbjiZZISREbLdXj4Fiqe+GO	TonSfsAav3azsQySS1SyNii5s1Kre2Q5BCUgWdNunC+IGB18s/6Ah2T5GfSuGm7eWXWJ	04nilmJJrdH9LYPv8VgNzqr7gvkub9QgNOMwc=</li>
<li><em>Domainkey-signature</em>: a=rsa-sha1; c=nofws; d=gmail.com; s=gamma;	h=content-type:subject:from:to:in-reply-to:references:date:message-id	:user-agent:content-transfer-encoding;	b=kMJ5hr6s6cYC5IZQ29lmf0Quhzc10JxQTuX0XT0znLswZNcc0rN2FFibwxoK6xFsaE	C+EoBBSGKUwYBu89oaLEcskZPk5vxirTYwqugNpWz+LdLEJLnc/KuEBmRsLD41AGMtFp	ZlKgQFoMXvzLb4sBWjWNYKNfKF4KRGcDr33Yw=</li>
<li><em>In-reply-to</em>: &lt;1298239068-sup-6985@whisper&gt;</li>
<li><em>List-archive</em>: &lt;<a href="http://rubyforge.org/pipermail/sup-devel">http://rubyforge.org/pipermail/sup-devel</a>&gt;</li>
<li><em>List-help</em>: &lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=help">mailto:sup-devel-request@rubyforge.org?subject=help</a>&gt;</li>
<li><em>List-id</em>: Sup developer discussion &lt;sup-devel.rubyforge.org&gt;</li>
<li><em>List-post</em>: &lt;<a href="mailto:sup-devel@rubyforge.org">mailto:sup-devel@rubyforge.org</a>&gt;</li>
<li><em>List-subscribe</em>: &lt;<a href="http://rubyforge.org/mailman/listinfo/sup-devel">http://rubyforge.org/mailman/listinfo/sup-devel</a>&gt;,	&lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=subscribe">mailto:sup-devel-request@rubyforge.org?subject=subscribe</a>&gt;</li>
<li><em>List-unsubscribe</em>: &lt;<a href="http://rubyforge.org/mailman/options/sup-devel">http://rubyforge.org/mailman/options/sup-devel</a>&gt;,	&lt;<a href="mailto:sup-devel-request@rubyforge.org?subject=unsubscribe">mailto:sup-devel-request@rubyforge.org?subject=unsubscribe</a>&gt;</li>
<li><em>References</em>: &lt;1298239068-sup-6985@whisper&gt;</li>
<li><em>Reply-to</em>: Sup developer discussion &lt;<a href="mailto:sup-devel%40rubyforge.org">sup-devel@rubyforge.org</a>&gt;</li>
<li><em>Sender</em>: <a href="mailto:sup-devel-bounces%40rubyforge.org">sup-devel-bounces@rubyforge.org</a></li>
<li><em>User-agent</em>: Sup/git</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Excerpts from Hamish's message of Sun Feb 20 22:02:54 +0000 2011:
&gt; For the moment this work is in the async_message_edit branch. If no one
&gt; shouts about this being a terrible idea then I'll merge it into next
&gt; within a week.

No one shouted, so I've merged it into next. At the end of the email is
the diff of the async_message_edit branch against where I started it.

Hamish Downer




diff --git a/lib/sup.rb b/lib/sup.rb
index 74eb950..213823c 100644
--- a/lib/sup.rb
+++ b/lib/sup.rb
@@ -370,6 +370,7 @@ require &quot;sup/horizontal-selector&quot;
 require &quot;sup/modes/line-cursor-mode&quot;
 require &quot;sup/modes/help-mode&quot;
 require &quot;sup/modes/edit-message-mode&quot;
+require &quot;sup/modes/edit-message-async-mode&quot;
 require &quot;sup/modes/compose-mode&quot;
 require &quot;sup/modes/resume-mode&quot;
 require &quot;sup/modes/forward-mode&quot;
diff --git a/lib/sup/buffer.rb b/lib/sup/buffer.rb
index 25ea132..444589a 100644
--- a/lib/sup/buffer.rb
+++ b/lib/sup/buffer.rb
@@ -73,7 +73,7 @@ class InputSequenceAborted &lt; StandardError; end
 class Buffer
   attr_reader :mode, :x, :y, :width, :height, :title, :atime
   bool_reader :dirty, :system
-  bool_accessor :force_to_top
+  bool_accessor :force_to_top, :hidden
 
   def initialize window, mode, width, height, opts={}
     @w = window
@@ -82,6 +82,7 @@ class Buffer
     @focus = false
     @title = opts[:title] || &quot;&quot;
     @force_to_top = opts[:force_to_top] || false
+    @hidden = opts[:hidden] || false
     @x, @y, @width, @height = 0, 0, width, height
     @atime = Time.at 0
     @system = opts[:system] || false
@@ -265,7 +266,7 @@ EOS
   end
 
   def rollable_buffers
-    @buffers.select { |b| !b.system? || @buffers.last == b }
+    @buffers.select { |b| !(b.system? || b.hidden?) || @buffers.last == b }
   end
 
   def handle_input c
diff --git a/lib/sup/modes/buffer-list-mode.rb b/lib/sup/modes/buffer-list-mode.rb
index 40f2e76..08bb604 100644
--- a/lib/sup/modes/buffer-list-mode.rb
+++ b/lib/sup/modes/buffer-list-mode.rb
@@ -28,7 +28,7 @@ protected
   end
 
   def regen_text
-    @bufs = BufferManager.buffers.reject { |name, buf| buf.mode == self }.sort_by { |name, buf| buf.atime }.reverse
+    @bufs = BufferManager.buffers.reject { |name, buf| buf.mode == self || buf.hidden? }.sort_by { |name, buf| buf.atime }.reverse
     width = @bufs.max_of { |name, buf| buf.mode.name.length }
     @text = @bufs.map do |name, buf|
       base_color = buf.system? ? :system_buf_color : :regular_buf_color
diff --git a/lib/sup/modes/edit-message-async-mode.rb b/lib/sup/modes/edit-message-async-mode.rb
new file mode 100644
index 0000000..385ba6a
--- /dev/null
+++ b/lib/sup/modes/edit-message-async-mode.rb
@@ -0,0 +1,89 @@
+module Redwood
+
+class EditMessageAsyncMode &lt; LineCursorMode
+
+  register_keymap do |k|
+    k.add :edit_finished, &quot;Finished editing message&quot;, 'E'
+    k.add :path_to_clipboard, &quot;Copy file path to the clipboard&quot;, :enter
+  end
+
+  def initialize parent_edit_mode, file_path, msg_subject
+    @parent_edit_mode = parent_edit_mode
+    @file_path = file_path
+    @orig_mtime = File.mtime @file_path
+
+    @text = [&quot;ASYNC MESSAGE EDIT&quot;,
+             &quot;&quot;, &quot;Your message with subject:&quot;,  msg_subject, &quot;is saved in a file:&quot;, &quot;&quot;, @file_path, &quot;&quot;, 
+             &quot;You can edit your message in the editor of your choice and continue to&quot;,
+             &quot;use sup while you edit your message.&quot;, &quot;&quot;,
+             &quot;Press &lt;Enter&gt; to have the file path copied to the clipboard.&quot;, &quot;&quot;,
+             &quot;When you have finished editing, select this buffer and press 'E'.&quot;,]
+    super()
+  end
+
+  def lines; @text.length end
+
+  def [] i
+    @text[i]
+  end
+
+  def killable?
+    if file_being_edited?
+      if !BufferManager.ask_yes_or_no(&quot;It appears the file is still being edited. Are you sure?&quot;)
+        return false
+      end
+    end
+
+    @parent_edit_mode.edit_message_async_resume true
+    true
+  end
+
+  def unsaved?
+    !file_being_edited? &amp;&amp; !file_has_been_edited?
+  end
+
+protected
+
+  def edit_finished
+    if file_being_edited?
+      if !BufferManager.ask_yes_or_no(&quot;It appears the file is still being edited. Are you sure?&quot;)
+        return false
+      end
+    end
+
+    @parent_edit_mode.edit_message_async_resume
+    BufferManager.kill_buffer buffer
+    true
+  end
+
+  def path_to_clipboard
+    if system(&quot;which xsel &gt; /dev/null 2&gt;&amp;1&quot;)
+      # linux/unix path
+      IO.popen('xsel --clipboard --input', 'r+') { |clipboard| clipboard.puts(@file_path) }
+      BufferManager.flash &quot;Copied file path to clipboard.&quot;
+    elsif system(&quot;which pbcopy &gt; /dev/null 2&gt;&amp;1&quot;)
+      # mac path
+      IO.popen('pbcopy', 'r+') { |clipboard| clipboard.puts(@file_path) }
+      BufferManager.flash &quot;Copied file path to clipboard.&quot;
+    else
+      BufferManager.flash &quot;No way to copy text to clipboard - try installing xsel.&quot;
+    end
+  end
+
+  def file_being_edited?
+    # check for common editor lock files
+    vim_lock_file = File.join(File.dirname(@file_path), '.'+File.basename(@file_path)+'.swp')
+    emacs_lock_file = File.join(File.dirname(@file_path), '.#'+File.basename(@file_path))
+
+    return true if File.exist?(vim_lock_file) || File.exist?(emacs_lock_file)
+
+    false
+  end
+
+  def file_has_been_edited?
+    File.mtime(@file_path) &gt; @orig_mtime
+  end
+
+end
+
+end
diff --git a/lib/sup/modes/edit-message-mode.rb b/lib/sup/modes/edit-message-mode.rb
index 734a879..01f3653 100644
--- a/lib/sup/modes/edit-message-mode.rb
+++ b/lib/sup/modes/edit-message-mode.rb
@@ -80,6 +80,7 @@ EOS
     k.add :edit_cc, &quot;Edit Cc:&quot;, 'c'
     k.add :edit_subject, &quot;Edit Subject&quot;, 's'
     k.add :edit_message, &quot;Edit message&quot;, :enter
+    k.add :edit_message_async, &quot;Edit message asynchronously&quot;, 'E'
     k.add :save_as_draft, &quot;Save as draft&quot;, 'P'
     k.add :attach_file, &quot;Attach a file&quot;, 'a'
     k.add :delete_attachment, &quot;Delete an attachment&quot;, 'd'
@@ -184,7 +185,51 @@ EOS
     @edited
   end
 
+  def edit_message_async
+    @file = Tempfile.new [&quot;sup.#{self.class.name.gsub(/.*::/, '').camel_to_hyphy}&quot;, &quot;.eml&quot;]
+    @file.puts format_headers(@header - NON_EDITABLE_HEADERS).first
+    @file.puts
+    @file.puts @body.join(&quot;\n&quot;)
+    @file.close
+
+    @mtime = File.mtime @file.path
+
+    # put up buffer saying you can now edit the message in another
+    # terminal or app, and continue to use sup in the meantime.
+    subject = @header[&quot;Subject&quot;] || &quot;&quot;
+    @async_mode = EditMessageAsyncMode.new self, @file.path, subject
+    BufferManager.spawn &quot;Waiting for message \&quot;#{subject}\&quot; to be finished&quot;, @async_mode
+
+    # hide ourselves, and wait for signal to resume from async mode ...
+    buffer.hidden = true
+  end
+
+  def edit_message_async_resume being_killed=false
+    buffer.hidden = false
+    @async_mode = nil
+    BufferManager.raise_to_front buffer if !being_killed
+
+    @edited = true if File.mtime(@file.path) &gt; @mtime
+
+    header, @body = parse_file @file.path
+    @header = header - NON_EDITABLE_HEADERS
+    handle_new_text @header, @body
+    update
+
+    true
+  end
+
   def killable?
+    if !@async_mode.nil?
+      return false if !@async_mode.killable?
+      if File.mtime(@file.path) &gt; @mtime
+        @edited = true
+        header, @body = parse_file @file.path
+        @header = header - NON_EDITABLE_HEADERS
+        handle_new_text @header, @body
+        update
+      end
+    end
     !edited? || BufferManager.ask_yes_or_no(&quot;Discard message?&quot;)
   end
_______________________________________________
Sup-devel mailing list
Sup-devel@rubyforge.org
<a  rel="nofollow" href="http://rubyforge.org/mailman/listinfo/sup-devel">http://rubyforge.org/mailman/listinfo/sup-devel</a>
</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00538" href="msg00538.html">Re: [sup-devel] editing messages outside of sup</a></strong>
<ul><li><em>From:</em> Alvaro Herrera &lt;alvherre@alvh.no-ip.org&gt;</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00577" href="msg00577.html">[sup-devel] editing messages outside of sup</a></strong>
<ul><li><em>From:</em> Hamish &lt;dmishd@gmail.com&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00583.html">Re: [sup-devel] sup-server revisited</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00412.html">Re: [sup-devel] sup-server revisited</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00577.html">[sup-devel] editing messages outside of sup</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00538.html">Re: [sup-devel] editing messages outside of sup</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#00549"><strong>Date</strong></a></li>
<li><a href="threads.html#00549"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</body>
</html>
