From c496e68930f9c0e134f37c060508d52cafd06bcc Mon Sep 17 00:00:00 2001
From: Tero Tilus <tero@tilus.net>
Date: Thu, 28 Oct 2010 14:01:12 +0300
Subject: [PATCH] Message#text_to_chunks: avoid O(n^2) behavior on sequences of blank lines

Signed-off-by: Tero Tilus <tero@tilus.net>
---
 lib/sup/message.rb |   13 ++++++++++++-
 1 files changed, 12 insertions(+), 1 deletions(-)

diff --git a/lib/sup/message.rb b/lib/sup/message.rb
index cf0e505..41e6486 100644
--- a/lib/sup/message.rb
+++ b/lib/sup/message.rb
@@ -590,9 +590,20 @@ private
     state = :text # one of :text, :quote, or :sig
     chunks = []
     chunk_lines = []
+    nextline_index = -1
 
     lines.each_with_index do |line, i|
-      nextline = lines[(i + 1) ... lines.length].find { |l| l !~ /^\s*$/ } # skip blank lines
+      if i >= nextline_index
+        # look for next nonblank line only when needed to avoid O(nÂ²)
+        # behavior on sequences of blank lines
+        if nextline_index = lines[(i+1)..-1].index { |l| l !~ /^\s*$/ } # skip blank lines
+          nextline_index += i + 1
+          nextline = lines[nextline_index]
+        else
+          nextline_index = lines.length
+          nextline = nil
+        end
+      end
 
       case state
       when :text
-- 
1.5.6.5

